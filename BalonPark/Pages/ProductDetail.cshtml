@page "/category/{categorySlug}/{subCategorySlug}/{productSlug}"
@model ProductDetailModel
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = $"{Model.Product?.Name} - {Model.Product?.CategoryName} | {companyName}";
    ViewData["Description"] = !string.IsNullOrEmpty(Model.Product?.Description) 
        ? $"{Model.Product.Name} - {Model.Product.Description.Substring(0, Math.Min(Model.Product.Description.Length, 150))}... | {Model.Product.CategoryName} - {Model.Product.SubCategoryName} | {companyName}"
        : $"{Model.Product?.Name} - {Model.Product?.CategoryName} - {Model.Product?.SubCategoryName} şişme oyun grubu. {companyName}'ta kaliteli şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar.";
    ViewData["Keywords"] = $"{Model.Product?.Name}, {Model.Product?.CategoryName}, {Model.Product?.SubCategoryName}, şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları, balon park, çocuk oyun grupları, şişme oyuncaklar, çocuk parkı, oyun alanı";
    ViewData["Image"] = Model.MainImage != null ? ((IUrlService?)ViewData["UrlService"])?.GetImageUrl(Model.MainImage.LargePath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{Model.MainImage.LargePath}" : ((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png";
    ViewData["ProductPrice"] = Model.Product?.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);
    ViewData["ProductCurrency"] = "TRY";
    ViewData["ProductAvailability"] = Model.Product?.Stock > 0 ? "in stock" : "out of stock";
    ViewData["ProductCondition"] = "new";
    ViewData["ProductBrand"] = companyName;
    ViewData["ProductSku"] = $"U-{Model.Product?.Id}";
}


<!-- Product Section Start -->
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex flex-wrap items-center gap-1.5 text-sm text-gray-500" aria-label="Breadcrumb">
        <a href="/" class="text-ink hover:text-primary transition">Ana Sayfa</a>
        <span>/</span>
        <a href="/category/@Model.Product?.CategorySlug" class="text-ink hover:text-primary transition">@Html.Raw(Model.Product?.CategoryName)</a>
        <span>/</span>
        <a href="/category/@Model.Product?.CategorySlug/@Model.Product?.SubCategorySlug" class="text-ink hover:text-primary transition">@Html.Raw(Model.Product?.SubCategoryName)</a>
        <span>/</span>
        <span class="text-ink font-medium">@Html.Raw(Model.Product?.Name)</span>
    </nav>

    <!-- Product Header -->
    <div class="flex flex-wrap items-start justify-between gap-3">
        <h1 class="text-ink text-xl font-medium">@Html.Raw(Model.Product?.Name)</h1>
        <div class="flex items-center gap-1">
            <button type="button" class="favorite-btn-detail w-9 h-9 rounded flex items-center justify-center text-gray-400 hover:text-primary hover:bg-gray-100 transition text-sm" data-product-id="@Model.Product?.Id" title="Favorilere Ekle"><i data-lucide="heart" class="w-4 h-4"></i></button>
            <button type="button" class="compare-btn-detail w-9 h-9 rounded flex items-center justify-center text-gray-400 hover:text-primary hover:bg-gray-100 transition text-sm" data-product-id="@Model.Product?.Id" data-product-url="/category/@Model.Product?.CategorySlug/@Model.Product?.SubCategorySlug/@Model.Product?.Slug" data-product-slug="@Model.Product?.Slug" title="Karşılaştır"><i data-lucide="shuffle" class="w-4 h-4"></i></button>
        </div>
    </div>

    <!-- Main Product Content -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Product Images -->
        <div class="product-gallery border border-gray-100 overflow-hidden bg-gray-50">
                        <!-- Main Swiper with lightGallery -->
                        <div class="swiper productMainSwiper" data-swiper-autoplay="false" id="lightgallery">
                            <div class="swiper-wrapper">
                                @if (Model.ProductImages.Any())
                                {
                                    @foreach (var image in Model.ProductImages)
                                    {
                                        <div class="swiper-slide">
                                            <div class="image-wrapper">
                                                <a href="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(image.LargePath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{image.LargePath}")"
                                                   data-lg-size="1600-1600"
                                                   data-src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(image.LargePath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{image.LargePath}")"
                                                   data-sub-html="<h4>@Html.Raw(Model.Product?.Name)</h4>"
                                                   class="block overflow-hidden bg-white">
                                                    <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(image.LargePath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{image.LargePath}")" 
                                                         class="lazy-image main-image w-full h-64 sm:h-80 lg:h-96 object-cover" 
                                                         alt="@Html.Raw(Model.Product?.Name)"
                                                         loading="lazy"
                                                         onerror="this.src='@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")'">
                                                </a>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="swiper-slide">
                                        <div class="image-wrapper">
                                            <a href="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")"
                                               data-lg-size="800-800"
                                               data-src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")"
                                               data-sub-html="<h4>@Html.Raw(Model.Product?.Name)</h4>"
                                               class="block overflow-hidden bg-white">
                                                <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")" 
                                                     class="lazy-image main-image w-full h-64 sm:h-80 lg:h-96 object-cover" 
                                                     alt="@Html.Raw(Model.Product?.Name)"
                                                     loading="lazy">
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                            <!-- Navigation buttons -->
                            <div class="swiper-button-next" aria-label="Next image"></div>
                            <div class="swiper-button-prev" aria-label="Previous image"></div>
                            <!-- Pagination -->
                            <div class="swiper-pagination" aria-label="Image pagination"></div>
                        </div>

                        @if (Model.ProductImages.Count > 1)
                        {
                            <!-- Thumbnail Swiper (büyük resimle aynı boşluk: 10px) -->
                            <div class="swiper productThumbsSwiper product-gallery-thumbs">
                                <div class="swiper-wrapper">
                                    @foreach (var image in Model.ProductImages)
                                    {
                                        <div class="swiper-slide">
                                            <div class="thumbnail-item flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 overflow-hidden border-2 border-transparent cursor-pointer" role="button" tabindex="0" aria-label="View image">
                                                <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(image.ThumbnailPath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{image.ThumbnailPath}")" 
                                                     class="lazy-image w-full h-full object-cover" 
                                                     alt="@Html.Raw(Model.Product?.Name)"
                                                     loading="lazy"
                                                     onerror="this.src='@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")'">
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
        </div>

        <!-- Product Information -->
        <div class="space-y-4">
            @{
                var selectedCurrency = ViewData["SelectedCurrency"]?.ToString() ?? "TL";
            }
            <!-- Price -->
            <div class="flex flex-wrap items-center justify-between gap-4 border-b border-gray-100 pb-4">
                <div>
                    @if (Model.Product?.Price <= 0)
                    {
                        <p class="text-sm text-gray-500">Fiyat için iletişime geçin</p>
                    }
                    else
                    {
                        <div class="price-main price-tl text-primary text-2xl font-semibold @(selectedCurrency == "TL" ? "block" : "hidden")">₺@Model.Product?.Price.ToString("N2")</div>
                        <div class="price-main price-usd text-primary text-2xl font-semibold @(selectedCurrency == "USD" ? "block" : "hidden")">$@Model.Product?.UsdPrice.ToString("N2")</div>
                        <div class="price-main price-eur text-primary text-2xl font-semibold @(selectedCurrency == "EUR" ? "block" : "hidden")">€@Model.Product?.EuroPrice.ToString("N2")</div>
                    }
                </div>
                <div class="flex items-center gap-1">
                    <a href="https://www.facebook.com/sharer/sharer.php?u=@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")" target="_blank" class="w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-[#1877f2] hover:bg-gray-100 transition" title="Facebook" aria-label="Facebook"><i data-lucide="facebook" class="w-4 h-4"></i></a>
                    <a href="https://twitter.com/intent/tweet?url=@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")&text=@(Uri.EscapeDataString(Model.Product?.Name ?? ""))" target="_blank" class="w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-[#1da1f2] hover:bg-gray-100 transition" title="Twitter" aria-label="Twitter"><i data-lucide="twitter" class="w-4 h-4"></i></a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")" target="_blank" class="w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-[#0077b5] hover:bg-gray-100 transition" title="LinkedIn" aria-label="LinkedIn"><i data-lucide="linkedin" class="w-4 h-4"></i></a>
                    <a href="https://wa.me/?text=@(Uri.EscapeDataString(Model.Product?.Name ?? ""))%20@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")" target="_blank" class="w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-[#25d366] hover:bg-gray-100 transition" title="WhatsApp" aria-label="WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                </div>
            </div>

            <!-- Product Code & WhatsApp -->
            <div class="flex flex-wrap items-center justify-between gap-3 py-3 border-b border-gray-100">
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-500 font-medium">Ürün Kodu:</span>
                    <span class="text-ink font-medium">U-@Model.Product?.Id</span>
                </div>
                <a href="https://wa.me/905336355039?text=@(Uri.EscapeDataString($"Bu ürün hakkında bilgi almak istiyorum: {Model.Product?.Name}"))%20@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")" target="_blank" class="inline-flex items-center gap-2 py-2 px-3 rounded bg-[#25d366] text-white text-sm font-medium hover:opacity-90 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                    <span>WhatsApp</span>
                </a>
            </div>

            <!-- Stock -->
            <div class="py-3 border-b border-gray-100">
                @if (Model.Product?.Stock > 0)
                {
                    <div class="flex items-center gap-2 text-sm text-support">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span>Stokta Mevcut</span>
                        <span class="text-gray-500">(@Model.Product.Stock adet)</span>
                    </div>
                }
                else
                {
                    <div class="flex items-center gap-2 text-sm text-accent">
                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                        <span>Stokta Yok</span>
                    </div>
                }
            </div>

            <!-- CTA -->
            <div>
                @if (Model.Product?.Stock > 0 && Model.Product?.Price > 0)
                {
                    <a href="https://wa.me/905336355039?text=@(Uri.EscapeDataString($"Bu ürünü satın almak istiyorum: {Model.Product?.Name} (Ürün Kodu: U-{Model.Product?.Id})"))%20@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")" target="_blank" class="inline-flex items-center gap-2 w-full justify-center py-3 px-4 rounded bg-primary text-white font-medium text-sm hover:bg-primary-dark transition" id="buy-now-button" aria-label="Satın Al">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span>Satın Al</span>
                    </a>
                }
                else if (Model.Product?.Price <= 0)
                {
                    <a href="https://wa.me/905336355039?text=@(Uri.EscapeDataString($"Bu ürün hakkında fiyat bilgisi almak istiyorum: {Model.Product?.Name}"))%20@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product?.CategorySlug ?? "", Model.Product?.SubCategorySlug ?? "", Model.Product?.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product?.CategorySlug}/{Model.Product?.SubCategorySlug}/{Model.Product?.Slug}")" target="_blank" class="inline-flex items-center gap-2 w-full justify-center py-3 px-4 rounded border border-gray-200 text-ink font-medium text-sm hover:bg-gray-50 transition" id="buy-now-button" aria-label="Fiyat Sor">
                        <i data-lucide="info" class="w-5 h-5"></i>
                        <span>Fiyat İçin İletişime Geçin</span>
                    </a>
                }
                else
                {
                    <button type="button" class="inline-flex items-center gap-2 w-full justify-center py-3 px-4 rounded border border-gray-200 text-gray-400 font-medium text-sm cursor-not-allowed" id="buy-now-button" disabled aria-label="Stokta Yok">
                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                        <span>Stokta Yok</span>
                    </button>
                }
            </div>

            <!-- Özet (ürün kartında da kullanılan kısa özet) -->
            @if (!string.IsNullOrEmpty(Model.Product?.Summary))
            {
                <div class="pt-3 mt-3 border-t border-gray-100">
                    <h3 class="text-ink text-sm font-semibold mb-2">Özet</h3>
                    <p class="text-sm text-ink leading-relaxed">@Html.Raw(Model.Product.Summary)</p>
                </div>
            }
        </div>
    </div>

    @{
        var hasInflated = !string.IsNullOrEmpty(Model.Product?.InflatedLength) || !string.IsNullOrEmpty(Model.Product?.InflatedWidth) || !string.IsNullOrEmpty(Model.Product?.InflatedHeight) || Model.Product?.UserCount != null;
        var hasAssembly = Model.Product?.AssemblyTime != null || Model.Product?.RequiredPersonCount != null || !string.IsNullOrEmpty(Model.Product?.FanDescription) || Model.Product?.FanWeightKg != null;
        var hasPackaged = !string.IsNullOrEmpty(Model.Product?.PackagedLength) || !string.IsNullOrEmpty(Model.Product?.PackagedDepth) || Model.Product?.PackagedWeightKg != null || Model.Product?.PackagePalletCount != null;
        var hasGeneral = Model.Product?.HasCertificate == true || !string.IsNullOrEmpty(Model.Product?.WarrantyDescription) || !string.IsNullOrEmpty(Model.Product?.AfterSalesService);
        var hasTechnicalInfo = hasInflated || hasAssembly || hasPackaged || hasGeneral;
        var hasDescription = !string.IsNullOrEmpty(Model.Product?.Description);
    }

    <!-- Açıklama (Ürün Teknik Bilgileri'nin üstünde) -->
    @if (hasDescription)
    {
        <div class="pt-4 mt-4 border-t border-gray-100">
            <h3 class="text-ink text-base font-medium pb-2 border-b border-gray-100 mb-3">Açıklama</h3>
            <div class="text-sm text-ink leading-relaxed">@Html.Raw(Model.Product?.Description)</div>
        </div>
    }

    <!-- Ürün Teknik Bilgileri -->
    @if (hasTechnicalInfo)
    {
        <div class="pt-4 mt-4 border-t border-gray-100">
            <h3 class="text-ink text-base font-medium pb-2 border-b border-gray-100 mb-4">Ürün Teknik Bilgileri</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                @if (hasInflated)
                {
                    <div class="rounded-lg border border-gray-200 bg-gray-50/50 p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Şişmiş ürün</h4>
                        <dl class="space-y-2 text-sm">
                            @if (!string.IsNullOrEmpty(Model.Product?.InflatedLength)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Uzunluk</dt><dd class="text-ink font-medium">@Model.Product.InflatedLength</dd></div> }
                            @if (!string.IsNullOrEmpty(Model.Product?.InflatedWidth)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Genişlik</dt><dd class="text-ink font-medium">@Model.Product.InflatedWidth</dd></div> }
                            @if (!string.IsNullOrEmpty(Model.Product?.InflatedHeight)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Yükseklik</dt><dd class="text-ink font-medium">@Model.Product.InflatedHeight</dd></div> }
                            @if (Model.Product?.UserCount != null) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Kullanıcı Sayısı</dt><dd class="text-ink font-medium">@Model.Product.UserCount</dd></div> }
                        </dl>
                    </div>
                }
                @if (hasAssembly)
                {
                    <div class="rounded-lg border border-gray-200 bg-gray-50/50 p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Montaj / demontaj</h4>
                        <dl class="space-y-2 text-sm">
                            @if (Model.Product?.AssemblyTime != null) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Montaj ve demontaj süresi</dt><dd class="text-ink font-medium">@(Model.Product.AssemblyTime) saat</dd></div> }
                            @if (Model.Product?.RequiredPersonCount != null) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Gerekli kişi sayısı</dt><dd class="text-ink font-medium">@(Model.Product.RequiredPersonCount) kişi</dd></div> }
                            @if (!string.IsNullOrEmpty(Model.Product?.FanDescription)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Fan</dt><dd class="text-ink font-medium">@Model.Product.FanDescription</dd></div> }
                            @if (Model.Product?.FanWeightKg != null) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Fan ağırlığı</dt><dd class="text-ink font-medium">@Model.Product.FanWeightKg kg</dd></div> }
                        </dl>
                    </div>
                }
                @if (hasPackaged)
                {
                    <div class="rounded-lg border border-gray-200 bg-gray-50/50 p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Paketlenmiş ürünün özellikleri</h4>
                        <dl class="space-y-2 text-sm">
                            @if (!string.IsNullOrEmpty(Model.Product?.PackagedLength)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Uzunluk</dt><dd class="text-ink font-medium">@Model.Product.PackagedLength</dd></div> }
                            @if (!string.IsNullOrEmpty(Model.Product?.PackagedDepth)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Derinlik</dt><dd class="text-ink font-medium">@Model.Product.PackagedDepth</dd></div> }
                            @if (Model.Product?.PackagedWeightKg != null) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Ağırlık</dt><dd class="text-ink font-medium">@Model.Product.PackagedWeightKg kg</dd></div> }
                            @if (Model.Product?.PackagePalletCount != null) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Paket / palet sayısı</dt><dd class="text-ink font-medium">@Model.Product.PackagePalletCount</dd></div> }
                        </dl>
                    </div>
                }
                @if (hasGeneral)
                {
                    <div class="rounded-lg border border-gray-200 bg-gray-50/50 p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Genel</h4>
                        <dl class="space-y-2 text-sm">
                            @if (Model.Product?.HasCertificate == true) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Sertifika</dt><dd class="text-ink font-medium">Sertifika var</dd></div> }
                            @if (!string.IsNullOrEmpty(Model.Product?.WarrantyDescription)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Garanti</dt><dd class="text-ink font-medium">@Model.Product.WarrantyDescription</dd></div> }
                            @if (!string.IsNullOrEmpty(Model.Product?.AfterSalesService)) { <div class="flex justify-between gap-2"><dt class="text-gray-500">Garanti Sonrası Hizmet</dt><dd class="text-ink font-medium">@Model.Product.AfterSalesService</dd></div> }
                        </dl>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Teknik Özellikler -->
    @if (!string.IsNullOrEmpty(Model.Product?.TechnicalDescription))
    {
        <div class="pt-4 border-t border-gray-100">
            <h3 class="text-ink text-base font-medium pb-2 border-b border-gray-100 mb-3">Teknik Özellikler</h3>
            <div class="text-sm text-ink prose prose-sm max-w-none">@Html.Raw(Model.Product.TechnicalDescription)</div>
        </div>
    }
</div>

<!-- Product Section End -->

@section Scripts {
<script>
    // Swiper instances
    let productMainSwiper;
    let productThumbsSwiper;

    // Initialize Swipers when DOM is loaded (Swiper 11: no loopedSlides)
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof window.Swiper === 'undefined') {
            console.warn('Swiper not loaded; product gallery will not be interactive.');
            return;
        }
        const mainSwiperElement = document.querySelector('.productMainSwiper');
        const thumbsSwiperElement = document.querySelector('.productThumbsSwiper');
        if (!mainSwiperElement) return;

        // Thumbnail swiper first (if exists) - eşit boşluk (spaceBetween: 10 her yerde)
        if (thumbsSwiperElement) {
            productThumbsSwiper = new window.Swiper('.productThumbsSwiper', {
                spaceBetween: 10,
                slidesPerView: 'auto',
                freeMode: true,
                watchSlidesProgress: true,
                breakpoints: {
                    320: { slidesPerView: 3 },
                    640: { slidesPerView: 4 },
                    768: { slidesPerView: 5 },
                    1024: { slidesPerView: 6 },
                },
            });
        }

        const slideCount = mainSwiperElement.querySelectorAll('.swiper-slide').length;
        const swiperConfig = {
            spaceBetween: 10,
            speed: 300,
            navigation: {
                nextEl: mainSwiperElement.querySelector('.swiper-button-next'),
                prevEl: mainSwiperElement.querySelector('.swiper-button-prev'),
            },
            pagination: {
                el: mainSwiperElement.querySelector('.swiper-pagination'),
                type: 'fraction',
                formatFractionCurrent: function (n) { return n; },
                formatFractionTotal: function (n) { return n; },
            },
            loop: slideCount > 1,
        };
        if (productThumbsSwiper) {
            swiperConfig.thumbs = { swiper: productThumbsSwiper };
        }

        productMainSwiper = new window.Swiper('.productMainSwiper', swiperConfig);
    });

    // Error handling for Swiper
    window.addEventListener('error', function(e) {
        if (e.message && e.message.includes('Swiper')) {
            // Fallback: show first image only
            const slides = document.querySelectorAll('.swiper-slide');
            slides.forEach((slide, index) => {
                if (index === 0) {
                    slide.style.display = 'block';
                } else {
                    slide.style.display = 'none';
                }
            });
        }
    });
</script>

<!-- lightGallery JS -->
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/lightgallery.min.js"></script>

<!-- lightGallery Plugins -->
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/thumbnail/lg-thumbnail.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/zoom/lg-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/autoplay/lg-autoplay.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/fullscreen/lg-fullscreen.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/rotate/lg-rotate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/share/lg-share.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/hash/lg-hash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/pager/lg-pager.min.js"></script>

<!-- lightGallery Initialization -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const lightGalleryElement = document.getElementById('lightgallery');
        
        if (lightGalleryElement) {
            lightGallery(lightGalleryElement, {
                // Core settings
                speed: 500,
                licenseKey: '0000-0000-000-0000', // Demo license
                
                // Plugins
                plugins: [
                    lgThumbnail,
                    lgZoom,
                    lgAutoplay,
                    lgFullscreen,
                    lgRotate,
                    lgShare,
                    lgHash,
                    lgPager
                ],
                
                // Thumbnail settings
                thumbnail: true,
                animateThumb: true,
                showThumbByDefault: true,
                thumbWidth: 100,
                thumbHeight: '80px',
                thumbMargin: 5,
                
                // Zoom settings
                zoom: true,
                scale: 1,
                actualSize: true,
                actualSizeIcons: {
                    zoomIn: 'lg-zoom-in',
                    zoomOut: 'lg-zoom-out',
                },
                
                // Autoplay settings
                autoplay: false,
                autoplayControls: true,
                progressBar: true,
                pause: 3000,
                
                // Fullscreen
                fullScreen: true,
                
                // Rotate & Flip
                rotate: true,
                flipHorizontal: true,
                flipVertical: true,
                rotateLeft: true,
                rotateRight: true,
                
                // Share settings
                share: true,
                facebook: true,
                twitter: true,
                pinterest: true,
                
                // Hash (URL)
                hash: true,
                galleryId: 'product-gallery',
                
                // Pager
                pager: true,
                
                // Additional settings
                download: true,
                counter: true,
                loop: true,
                escKey: true,
                keyPress: true,
                controls: true,
                slideEndAnimation: true,
                hideControlOnEnd: false,
                mousewheel: true,
                
                // Mobile
                mobileSettings: {
                    controls: true,
                    showCloseIcon: true,
                    download: true,
                    rotate: true
                },
                
                // Animation
                mode: 'lg-fade',
                
                // Selector (work with swiper)
                selector: 'a',
                
                // Accessibility
                ariaLabelledby: 'Product Gallery',
                ariaDescribedby: '@Html.Raw(Model.Product?.Name ?? "")',
            });
            
            console.log('lightGallery initialized with all features');
        }
    });
</script>
}

@section Styles {
<!-- lightGallery CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/css/lightgallery-bundle.min.css">
<style>
    /* Swiper/lightGallery overrides only - layout uses Tailwind */
    .productMainSwiper .swiper-button-next,
    .productMainSwiper .swiper-button-prev { color: #222; }
    .productMainSwiper .swiper-pagination-fraction { color: #222; }
    .productThumbsSwiper .swiper-slide-thumb-active .thumbnail-item { border-color: #00A8E8; }
    .product-gallery-thumbs { margin-top: 5px; }
    .product-gallery .image-wrapper,
    .product-gallery .image-wrapper a,
    .product-gallery .swiper-slide,
    .productMainSwiper .swiper-slide,
    .productThumbsSwiper .thumbnail-item { border-radius: 0; }
    .image-wrapper { overflow: hidden; }
</style>
}

<!-- Product Structured Data -->
@if (Model.Product != null)
{
    var jsonName = System.Text.Json.JsonSerializer.Serialize(Model.Product.Name);
    var jsonDescription = System.Text.Json.JsonSerializer.Serialize(Model.Product.Description ?? Model.Product.Name);
    var jsonCategoryName = System.Text.Json.JsonSerializer.Serialize(Model.Product.CategoryName ?? "Şişme Oyun Parkları");
    var jsonCompanyName = System.Text.Json.JsonSerializer.Serialize(Model.SiteSettings?.CompanyName ?? "Balon Park");
    var jsonCompanyNameFull = System.Text.Json.JsonSerializer.Serialize(Model.SiteSettings?.CompanyName ?? "Balon Park Şişme Oyun Grupları");
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "Product",
        "name": @Html.Raw(jsonName),
        "description": @Html.Raw(jsonDescription),
        "image": [
            @if (Model.ProductImages.Any())
            {
                var images = Model.ProductImages.Take(5).ToList();
                for (int i = 0; i < images.Count; i++)
                {
                    var image = images[i];
                    @: "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(image.LargePath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{image.LargePath}")"@(i < images.Count - 1 ? "," : "")
                }
            }
            else
            {
                @: "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")"
            }
        ],
        "sku": "U-@Model.Product.Id",
        "mpn": "U-@Model.Product.Id",
        "brand": {
            "@@type": "Brand",
            "name": @Html.Raw(jsonCompanyName)
        },
        "category": @Html.Raw(jsonCategoryName),
        "additionalProperty": [
            {
                "@@type": "PropertyValue",
                "name": "Stok Durumu",
                "value": "@(Model.Product.Stock > 0 ? "Stokta Mevcut" : "Stokta Yok")"
            }
        ],
        "offers": {
            "@@type": "Offer",
            "price": "@Model.Product.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)",
            "priceCurrency": "TRY",
            "availability": "@(Model.Product.Stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")",
            "itemCondition": "https://schema.org/NewCondition",
            "seller": {
                "@@type": "Organization",
                "name": @Html.Raw(jsonCompanyNameFull),
                "url": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"{HttpContext.Request.Path}{HttpContext.Request.QueryString}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}{HttpContext.Request.Path}{HttpContext.Request.QueryString}")"
            },
            "priceValidUntil": "@DateTime.Now.AddDays(30).ToString("yyyy-MM-dd")",
            "shippingDetails": {
                "@@type": "OfferShippingDetails",
                "shippingRate": {
                    "@@type": "MonetaryAmount",
                    "value": "0",
                    "currency": "TRY"
                },
                "shippingDestination": {
                    "@@type": "DefinedRegion",
                    "addressCountry": "TR"
                },
                "deliveryTime": {
                    "@@type": "ShippingDeliveryTime",
                    "businessDays": {
                        "@@type": "OpeningHoursSpecification",
                        "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
                    },
                    "cutoffTime": "14:00",
                    "handlingTime": {
                        "@@type": "QuantitativeValue",
                        "minValue": 1,
                        "maxValue": 2,
                        "unitCode": "DAY"
                    },
                    "transitTime": {
                        "@@type": "QuantitativeValue",
                        "minValue": 1,
                        "maxValue": 3,
                        "unitCode": "DAY"
                    }
                },
                "potentialAction": {
                    "@@type": "BuyAction",
                    "target": {
                        "@@type": "EntryPoint",
                        "urlTemplate": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product.CategorySlug ?? "", Model.Product.SubCategorySlug ?? "", Model.Product.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product.CategorySlug}/{Model.Product.SubCategorySlug}/{Model.Product.Slug}")",
                        "actionPlatform": [
                            "http://schema.org/DesktopWebPlatform",
                            "http://schema.org/MobileWebPlatform"
                        ]
                    }
                }
            }
        },
        "aggregateRating": {
            "@@type": "AggregateRating",
            "ratingValue": "4.8",
            "reviewCount": "150",
            "bestRating": "5",
            "worstRating": "1"
        },
        "review": [
            {
                "@@type": "Review",
                "reviewRating": {
                    "@@type": "Rating",
                    "ratingValue": "5",
                    "bestRating": "5"
                },
                "author": {
                    "@@type": "Person",
                    "name": "Müşteri"
                },
                "reviewBody": "Çok kaliteli ve güvenli ürün. Malzeme kalitesi çok iyi.",
                "datePublished": "@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")"
            }
        ],
        "url": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product.CategorySlug ?? "", Model.Product.SubCategorySlug ?? "", Model.Product.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product.CategorySlug}/{Model.Product.SubCategorySlug}/{Model.Product.Slug}")",
        "isRelatedTo": {
            "@@type": "Product",
            "name": "Şişme Oyun Parkları",
            "category": "Çocuk Oyun Grupları"
        }
    }
    </script>
}

<!-- BreadcrumbList Structured Data -->
@if (Model.Product != null)
{
    var breadcrumbCategoryName = System.Text.Json.JsonSerializer.Serialize(Model.Product.CategoryName ?? "Kategoriler");
    var breadcrumbSubCategoryName = System.Text.Json.JsonSerializer.Serialize(Model.Product.SubCategoryName ?? "Alt Kategoriler");
    var breadcrumbProductName = System.Text.Json.JsonSerializer.Serialize(Model.Product.Name);
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@@type": "ListItem",
                "position": 1,
                "name": "Ana Sayfa",
                "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl("/") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/")"
            },
            {
                "@@type": "ListItem",
                "position": 2,
                "name": @Html.Raw(breadcrumbCategoryName),
                "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.Product.CategorySlug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product.CategorySlug}")"
            },
            {
                "@@type": "ListItem",
                "position": 3,
                "name": @Html.Raw(breadcrumbSubCategoryName),
                "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.Product.CategorySlug}/{Model.Product.SubCategorySlug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product.CategorySlug}/{Model.Product.SubCategorySlug}")"
            },
            {
                "@@type": "ListItem",
                "position": 4,
                "name": @Html.Raw(breadcrumbProductName),
                "item": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Product.CategorySlug ?? "", Model.Product.SubCategorySlug ?? "", Model.Product.Slug ?? "") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Product.CategorySlug}/{Model.Product.SubCategorySlug}/{Model.Product.Slug}")"
            }
        ]
    }
    </script>
}

