@page "/search"
@model SearchModel
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = "Arama Sonuçları";
    ViewData["Description"] = $"'{Model.Query}' için arama sonuçları - {companyName}";
    ViewData["Keywords"] = $"arama, {Model.Query}, şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları, balon park";
    ViewData["Image"] = settings?.Logo != null ? (((IUrlService?)ViewData["UrlService"])?.GetImageUrl(settings.Logo) ?? settings.Logo) : (((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/logo/logo.png");
}

<!-- Search Results Page Structured Data -->
<script type="application/ld+json">
{
    "@@context": "https://schema.org",
    "@@type": "SearchResultsPage",
    "name": "Arama Sonuçları - '@Html.Raw(Model.Query)'",
    "description": "'@Html.Raw(Model.Query)' için arama sonuçları - @Html.Raw(companyName)",
    "url": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/search?q={Uri.EscapeDataString(Model.Query)}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/search?q={Uri.EscapeDataString(Model.Query)}")",
    "mainEntity": {
        "@@type": "ItemList",
        "name": "'@Html.Raw(Model.Query)' Arama Sonuçları",
        "description": "'@Html.Raw(Model.Query)' için bulunan ürünler ve kategoriler",
        "numberOfItems": "@Model.Products.Count()",
        "itemListElement": [
            @{
                int itemCount = 0;
                int maxItems = 20;
                foreach (var productWithImage in Model.Products.Take(maxItems))
                {
                    var product = productWithImage.Product;
                    @: {
                    @:     "@@type": "ListItem",
                    @:     "position": @(itemCount + 1),
                    @:     "item": {
                    @:         "@@type": "Product",
                    @:         "name": "@Html.Raw(product.Name)",
                    @:         "description": "@Html.Raw(product.Description ?? product.Name)",
                    @:         "url": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(product.CategorySlug ?? "", product.SubCategorySlug ?? "", product.Slug) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{product.CategorySlug}/{product.SubCategorySlug}/{product.Slug}")",
                    @:         "image": "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(productWithImage.MainImage?.LargePath ?? "/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{(productWithImage.MainImage?.LargePath ?? "/assets/images/logo/logo.png")}")",
                    @:         "offers": {
                    @:             "@@type": "Offer",
                    @:             "price": "@product.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)",
                    @:             "priceCurrency": "TRY",
                    @:             "availability": "@(product.Stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")"
                    @:         },
                    @:         "category": "@Html.Raw(product.CategoryName ?? "")"
                    @:     }
                    @: }@(itemCount < maxItems - 1 ? "," : "")
                    itemCount++;
                }
            }
        ]
    },
    "breadcrumb": {
        "@@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@@type": "ListItem",
                "position": 1,
                "name": "Ana Sayfa",
                "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl("/") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/")"
            },
            {
                "@@type": "ListItem",
                "position": 2,
                "name": "Arama Sonuçları",
                "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/search?q={Uri.EscapeDataString(Model.Query)}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/search?q={Uri.EscapeDataString(Model.Query)}")"
            }
        ]
    }
}
</script>

<div class="space-y-4 sm:space-y-6">
    <nav class="flex items-center gap-1.5 text-sm text-gray-500" aria-label="Breadcrumb">
        <a href="/" class="text-ink hover:text-primary transition">Ana Sayfa</a>
        <span>/</span>
        <span class="text-ink font-medium">Arama Sonuçları</span>
    </nav>

    <div class="pt-1 pb-2.5 border-b border-gray-100">
        <h2 class="text-ink text-base font-medium">Arama Sonuçları</h2>
        <p class="text-gray-400 text-xs mt-0.5">
            @if (!string.IsNullOrEmpty(Model.Query))
            {
                <span>"<strong class="text-ink">@Model.Query</strong>" için @Model.Products.Count() ürün bulundu</span>
            }
            else
            {
                <span>Lütfen arama yapmak için bir kelime girin</span>
            }
        </p>
    </div>

    @if (Model.Products.Any())
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            @foreach (var item in Model.Products)
            {
                <article class="group bg-white rounded border border-gray-100 overflow-hidden hover:border-gray-200 hover:bg-gray-50/50 transition-all duration-200 flex flex-col">
                    <div class="relative aspect-square bg-gray-50 overflow-hidden">
                        <div class="absolute top-2 right-2 z-10 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button type="button" class="favorite-btn w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-primary hover:bg-white/90 hover:shadow text-sm transition" data-product-id="@item.Product.Id" title="Favori"><i class="fa-regular fa-heart"></i></button>
                            <button type="button" class="compare-btn w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-primary hover:bg-white/90 hover:shadow text-sm transition" data-product-id="@item.Product.Id" title="Karşılaştır"><i class="fa-solid fa-shuffle"></i></button>
                        </div>
                        <a href="/category/@item.Product.CategorySlug/@item.Product.SubCategorySlug/@item.Product.Slug" class="block w-full h-full">
                            @if (item.MainImage != null)
                            {
                                <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(item.MainImage.ThumbnailPath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{item.MainImage.ThumbnailPath}")" class="lazy-image w-full h-full object-cover group-hover:opacity-95 transition-opacity duration-200" alt="@Html.Raw(item.Product.Name)" loading="lazy">
                            }
                            else
                            {
                                <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")" class="lazy-image w-full h-full object-cover" alt="@Html.Raw(item.Product.Name)" loading="lazy">
                            }
                        </a>
                    </div>
                    <div class="p-3 flex flex-col flex-1 border-t border-gray-100">
                        <a href="/category/@item.Product.CategorySlug/@item.Product.SubCategorySlug/@item.Product.Slug" class="font-medium text-sm text-ink hover:text-primary line-clamp-2 transition">@Html.Raw(item.Product.Name)</a>
                        <p class="text-xs text-gray-400 mt-0.5">@Html.Raw(item.Product.CategoryName)</p>
                        @if (!string.IsNullOrEmpty(item.Product.Description))
                        {
                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">@Html.Raw(item.Product.Description.Length > 60 ? item.Product.Description.Substring(0, 60) + "..." : item.Product.Description)</p>
                        }
                        @if (!string.IsNullOrEmpty(item.Product.Dimensions))
                        {
                            <p class="text-[11px] text-gray-400 mt-1 flex items-center gap-1"><i class="fa-solid fa-ruler-combined w-3.5"></i> @Html.Raw(item.Product.Dimensions)</p>
                        }
                        <div class="mt-auto pt-2.5">
                            @if (item.Product.Price <= 0)
                            {
                                <p class="text-xs text-gray-500">Fiyat için iletişime geçin</p>
                            }
                            else
                            {
                                <p class="price-tl text-sm font-medium text-primary @(Model.SelectedCurrency == "TL" ? "block" : "hidden")">₺@item.Product.Price.ToString("N2")</p>
                                <p class="price-usd text-sm font-medium text-primary @(Model.SelectedCurrency == "USD" ? "block" : "hidden")">$@item.Product.UsdPrice.ToString("N2")</p>
                                <p class="price-eur text-sm font-medium text-primary @(Model.SelectedCurrency == "EUR" ? "block" : "hidden")">€@item.Product.EuroPrice.ToString("N2")</p>
                            }
                        </div>
                    </div>
                </article>
            }
        </div>
    }
    else if (!string.IsNullOrEmpty(Model.Query))
    {
        <div class="col-span-full text-center py-12 px-4 bg-gray-50 rounded border border-gray-100">
            <i class="fa-solid fa-search text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-base font-medium text-ink">"@Model.Query" için ürün bulunamadı</h3>
            <p class="text-sm text-gray-500 mt-1">Farklı anahtar kelimelerle arama yapmayı deneyin veya kategorilerimizi inceleyin.</p>
            <a href="/" class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium text-sm transition w-fit">
                <i class="fa-solid fa-home"></i> Ana Sayfaya Dön
            </a>
        </div>
    }
    else
    {
        <div class="col-span-full text-center py-12 px-4 bg-gray-50 rounded border border-gray-100">
            <i class="fa-solid fa-exclamation-triangle text-4xl text-gray-300 mb-3"></i>
            <h3 class="text-base font-medium text-ink">Arama terimi gerekli</h3>
            <p class="text-sm text-gray-500 mt-1">Lütfen arama yapmak için bir kelime girin.</p>
            <a href="/" class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium text-sm transition w-fit">
                <i class="fa-solid fa-home"></i> Ana Sayfaya Dön
            </a>
        </div>
    }
</div>
