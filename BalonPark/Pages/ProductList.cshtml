@page "/products"
@model ProductListModel
@using BalonPark.Models
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = "Ürünler | Şişme Oyun Parkı Kataloğu - " + companyName;
    ViewData["Description"] = "Tüm şişme oyun parkları, kaydıraklar, havuzlar ve çocuk oyun grupları. " + companyName + " ürün kataloğu. Filtreleyerek arayın.";
    ViewData["Keywords"] = "şişme oyun parkı, şişme kaydırak, şişme havuz, ürünler, katalog, çocuk oyun grupları";
    ViewData["Image"] = settings?.Logo != null ? (((IUrlService?)ViewData["UrlService"])?.GetImageUrl(settings.Logo) ?? settings.Logo) : (((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/logo/logo.png");
}

<div class="space-y-4 sm:space-y-6">
    @await Html.PartialAsync("Shared/_Breadcrumb", new List<BreadcrumbItem>
    {
        BreadcrumbItem.Link("Ana Sayfa", "/"),
        BreadcrumbItem.Current("Ürünler")
    })

    <header class="sr-only">
        <h1>Ürünler – Şişme Oyun Parkı, Kaydırak ve Havuz Kataloğu</h1>
    </header>

    <!-- Filtreler: Tailwind custom select menü + input (WAI-ARIA listbox pattern) -->
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4 sm:p-6">
        <form method="get" id="filterForm" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Kategori: custom menü -->
                <div class="relative product-list-select-menu" data-select-id="CategoryId">
                    <select name="CategoryId" id="CategoryId" class="sr-only product-list-select-native" aria-label="Kategori" tabindex="-1" aria-hidden="true">
                        <option value="">Tüm kategoriler</option>
                        @foreach (var cat in Model.FilterCategories)
                        {
                            @if (Model.CategoryId == cat.Id)
                            {<option value="@cat.Id" selected>@Html.Raw(cat.Name)</option>}
                            else
                            {<option value="@cat.Id">@Html.Raw(cat.Name)</option>}
                        }
                    </select>
                    <button type="button" class="product-list-select-trigger relative w-full h-12 pl-4 pr-10 text-left text-base bg-white border border-gray-200 rounded-lg text-gray-700 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="CategoryId-label" id="CategoryId-trigger">
                        <span class="block truncate product-list-select-value">Tüm kategoriler</span>
                        <span class="pointer-events-none absolute right-3 flex items-center text-gray-400">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                        </span>
                    </button>
                    <ul class="product-list-select-dropdown absolute z-50 mt-2 w-full max-h-60 overflow-auto rounded-lg bg-white py-1.5 text-sm shadow-xl ring-1 ring-black/5 focus:outline-none transition-all duration-200 ease-out origin-top opacity-0 scale-95 pointer-events-none invisible" role="listbox" aria-labelledby="CategoryId-trigger" id="CategoryId-listbox"></ul>
                </div>
                <!-- Alt Kategori: custom menü -->
                <div class="relative product-list-select-menu" data-select-id="SubCategoryId">
                    <select name="SubCategoryId" id="SubCategoryId" class="sr-only product-list-select-native" aria-label="Alt Kategori" tabindex="-1" aria-hidden="true">
                        <option value="">Tüm alt kategoriler</option>
                        @foreach (var sub in Model.FilterSubCategories)
                        {
                            @if (Model.SubCategoryId == sub.Id)
                            {<option value="@sub.Id" selected>@Html.Raw(sub.Name)</option>}
                            else
                            {<option value="@sub.Id">@Html.Raw(sub.Name)</option>}
                        }
                    </select>
                    <button type="button" class="product-list-select-trigger relative w-full h-12 pl-4 pr-10 text-left text-base bg-white border border-gray-200 rounded-lg text-gray-700 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="SubCategoryId-label" id="SubCategoryId-trigger">
                        <span class="block truncate product-list-select-value">Tüm alt kategoriler</span>
                        <span class="pointer-events-none absolute right-3 flex items-center text-gray-400">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                        </span>
                    </button>
                    <ul class="product-list-select-dropdown absolute z-50 mt-2 w-full max-h-60 overflow-auto rounded-lg bg-white py-1.5 text-sm shadow-xl ring-1 ring-black/5 focus:outline-none transition-all duration-200 ease-out origin-top opacity-0 scale-95 pointer-events-none invisible" role="listbox" aria-labelledby="SubCategoryId-trigger" id="SubCategoryId-listbox"></ul>
                </div>
                <!-- Ürün adı: menü stil input (leading icon) -->
                <div class="relative">
                    <span class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400" aria-hidden="true">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </span>
                    <input type="text" name="ProductNameFilter" id="ProductNameFilter" value="@Model.ProductNameFilter" placeholder="Ürün adı ara..." class="w-full h-12 pl-11 pr-4 text-base border border-gray-200 rounded-lg text-gray-700 placeholder-gray-400 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors" aria-label="Ürün adı">
                </div>
                <!-- Sırala: custom menü -->
                <div class="relative product-list-select-menu" data-select-id="SortBy">
                    <select name="SortBy" id="SortBy" class="sr-only product-list-select-native" aria-label="Sırala" tabindex="-1" aria-hidden="true">
                        @if (string.IsNullOrEmpty(Model.SortBy) || Model.SortBy == "displayOrder") {<option value="displayOrder" selected>Site sırası</option>} else {<option value="displayOrder">Site sırası</option>}
                        @if (Model.SortBy == "newest") {<option value="newest" selected>En yeni</option>} else {<option value="newest">En yeni</option>}
                        @if (Model.SortBy == "oldest") {<option value="oldest" selected>En eski</option>} else {<option value="oldest">En eski</option>}
                        @if (Model.SortBy == "name") {<option value="name" selected>Ad (A-Z)</option>} else {<option value="name">Ad (A-Z)</option>}
                        @if (Model.SortBy == "nameDesc") {<option value="nameDesc" selected>Ad (Z-A)</option>} else {<option value="nameDesc">Ad (Z-A)</option>}
                        @if (Model.SortBy == "price") {<option value="price" selected>Fiyat (düşük → yüksek)</option>} else {<option value="price">Fiyat (düşük → yüksek)</option>}
                        @if (Model.SortBy == "priceDesc") {<option value="priceDesc" selected>Fiyat (yüksek → düşük)</option>} else {<option value="priceDesc">Fiyat (yüksek → düşük)</option>}
                    </select>
                    <button type="button" class="product-list-select-trigger relative w-full h-12 pl-4 pr-10 text-left text-base bg-white border border-gray-200 rounded-lg text-gray-700 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="SortBy-label" id="SortBy-trigger">
                        <span class="block truncate product-list-select-value">En yeni</span>
                        <span class="pointer-events-none absolute right-3 flex items-center text-gray-400">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                        </span>
                    </button>
                    <ul class="product-list-select-dropdown absolute z-50 mt-2 w-full max-h-60 overflow-auto rounded-lg bg-white py-1.5 text-sm shadow-xl ring-1 ring-black/5 focus:outline-none transition-all duration-200 ease-out origin-top opacity-0 scale-95 pointer-events-none invisible" role="listbox" aria-labelledby="SortBy-trigger" id="SortBy-listbox"></ul>
                </div>
            </div>
        </form>
    </div>

    @if (Model.Products.Any())
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            @foreach (var item in Model.Products)
            {
                var product = item.Product;
                var productUrl = $"/category/{product.CategorySlug}/{product.SubCategorySlug}/{product.Slug}";
                @await Html.PartialAsync("Shared/_ProductCard", new ProductCardViewModel { Item = item, ProductUrl = productUrl, SelectedCurrency = Model.SelectedCurrency })
            }
        </div>

        @if (Model.TotalPages > 1)
        {
            <nav class="flex justify-center items-center gap-1.5 flex-wrap mt-6" aria-label="Sayfa navigasyonu">
                @if (Model.PageNumber > 1)
                {
                    <a href="/products@(Model.GetFilterQueryString(Model.PageNumber - 1))" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition" aria-label="Önceki">&laquo;</a>
                }
                @{
                    int startPage = Math.Max(1, Model.PageNumber - 2);
                    int endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                }
                @if (startPage > 1)
                {
                    <a href="/products@(Model.GetFilterQueryString(1))" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">1</a>
                    @if (startPage > 2) { <span class="px-1.5 text-gray-400 text-sm">...</span> }
                }
                @for (int i = startPage; i <= endPage; i++)
                {
                    @if (i == Model.PageNumber)
                    {
                        <span class="inline-flex items-center justify-center w-9 h-9 rounded bg-primary text-white text-sm font-medium">@i</span>
                    }
                    else
                    {
                        <a href="/products@(Model.GetFilterQueryString(i))" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">@i</a>
                    }
                }
                @if (endPage < Model.TotalPages)
                {
                    @if (endPage < Model.TotalPages - 1) { <span class="px-1.5 text-gray-400 text-sm">...</span> }
                    <a href="/products@(Model.GetFilterQueryString(Model.TotalPages))" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">@Model.TotalPages</a>
                }
                @if (Model.PageNumber < Model.TotalPages)
                {
                    <a href="/products@(Model.GetFilterQueryString(Model.PageNumber + 1))" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition" aria-label="Sonraki">&raquo;</a>
                }
                <span class="text-xs text-gray-500 ml-3">Sayfa @Model.PageNumber / @Model.TotalPages (@Model.TotalProducts ürün)</span>
            </nav>
        }
    }
    else
    {
        @await Html.PartialAsync("Shared/_ResultNotFound", new ResultNotFoundViewModel
        {
            Icon = "package-open",
            Title = "Ürün bulunamadı",
            Description = "Filtreleri değiştirerek tekrar deneyin.",
            PrimaryActionText = "Filtreleri temizle",
            PrimaryActionUrl = "/products",
            PrimaryActionIcon = "rotate-ccw",
            PrimaryActionIsPrimary = false
        })
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Custom select menü: WAI-ARIA listbox pattern, keyboard nav, click outside
            (function() {
                var form = document.getElementById('filterForm');
                var menus = document.querySelectorAll('.product-list-select-menu');
                var openMenu = null;

                function getSelectedText(selectEl) {
                    var opt = selectEl.options[selectEl.selectedIndex];
                    return opt ? opt.textContent.trim() : '';
                }

                function buildListbox(selectId) {
                    var select = document.getElementById(selectId);
                    var listbox = document.getElementById(selectId + '-listbox');
                    var trigger = document.getElementById(selectId + '-trigger');
                    if (!select || !listbox || !trigger) return;
                    listbox.innerHTML = '';
                    for (var i = 0; i < select.options.length; i++) {
                        var opt = select.options[i];
                        var li = document.createElement('li');
                        li.setAttribute('role', 'option');
                        li.setAttribute('data-value', opt.value);
                        li.setAttribute('data-index', i);
                        li.className = 'product-list-select-option relative cursor-pointer select-none py-2.5 pl-3 pr-9 text-gray-900 hover:bg-gray-50 focus:bg-gray-50 focus:outline-none';
                        if (opt.selected) li.setAttribute('aria-selected', 'true');
                        li.textContent = opt.textContent.trim();
                        listbox.appendChild(li);
                    }
                    trigger.querySelector('.product-list-select-value').textContent = getSelectedText(select);
                }

                function closeAll() {
                    menus.forEach(function(wrapper) {
                        var listbox = wrapper.querySelector('.product-list-select-dropdown');
                        var trigger = wrapper.querySelector('.product-list-select-trigger');
                        if (listbox) listbox.classList.remove('product-list-select-dropdown-open');
                        if (trigger) trigger.setAttribute('aria-expanded', 'false');
                    });
                    openMenu = null;
                }

                function openListbox(wrapper) {
                    closeAll();
                    var listbox = wrapper.querySelector('.product-list-select-dropdown');
                    var trigger = wrapper.querySelector('.product-list-select-trigger');
                    if (listbox && trigger) {
                        listbox.classList.add('product-list-select-dropdown-open');
                        trigger.setAttribute('aria-expanded', 'true');
                        openMenu = wrapper;
                        var activeOpt = listbox.querySelector('[aria-selected="true"]') || listbox.querySelector('[role="option"]');
                        if (activeOpt) {
                            listbox.setAttribute('aria-activedescendant', activeOpt.id || '');
                            activeOpt.classList.add('product-list-select-option-active', 'bg-gray-100');
                        }
                    }
                }

                menus.forEach(function(wrapper) {
                    var selectId = wrapper.getAttribute('data-select-id');
                    var select = document.getElementById(selectId);
                    var listbox = document.getElementById(selectId + '-listbox');
                    var trigger = document.getElementById(selectId + '-trigger');
                    if (!select || !listbox || !trigger) return;

                    buildListbox(selectId);

                    // Option id for aria-activedescendant
                    var options = listbox.querySelectorAll('[role="option"]');
                    options.forEach(function(li, idx) {
                        if (!li.id) li.id = selectId + '-option-' + idx;
                    });

                    trigger.addEventListener('click', function(e) {
                        e.preventDefault();
                        var isOpen = listbox.classList.contains('product-list-select-dropdown-open');
                        if (isOpen) closeAll();
                        else openListbox(wrapper);
                    });

                    listbox.querySelectorAll('[role="option"]').forEach(function(li) {
                        li.addEventListener('click', function(e) {
                            e.preventDefault();
                            var val = li.getAttribute('data-value');
                            select.value = val;
                            trigger.querySelector('.product-list-select-value').textContent = li.textContent.trim();
                            listbox.querySelectorAll('[role="option"]').forEach(function(o) {
                                o.setAttribute('aria-selected', o === li ? 'true' : 'false');
                            });
                            closeAll();
                            if (selectId === 'CategoryId') {
                                var sub = document.getElementById('SubCategoryId');
                                if (sub) sub.value = '';
                                buildListbox('SubCategoryId');
                                var subTrigger = document.getElementById('SubCategoryId-trigger');
                                if (subTrigger) subTrigger.querySelector('.product-list-select-value').textContent = getSelectedText(sub);
                            }
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                            form.submit();
                        });
                    });

                    trigger.addEventListener('keydown', function(e) {
                        if (!listbox.classList.contains('product-list-select-dropdown-open')) {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                openListbox(wrapper);
                            }
                            return;
                        }
                        var opts = listbox.querySelectorAll('[role="option"]');
                        var current = listbox.querySelector('.product-list-select-option-active') || opts[0];
                        var idx = current ? Array.prototype.indexOf.call(opts, current) : 0;
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            closeAll();
                            trigger.focus();
                        } else if (e.key === 'ArrowDown' && idx < opts.length - 1) {
                            e.preventDefault();
                            opts[idx].classList.remove('product-list-select-option-active', 'bg-gray-100');
                            opts[idx + 1].classList.add('product-list-select-option-active', 'bg-gray-100');
                            listbox.setAttribute('aria-activedescendant', opts[idx + 1].id || '');
                            opts[idx + 1].scrollIntoView({ block: 'nearest' });
                        } else if (e.key === 'ArrowUp' && idx > 0) {
                            e.preventDefault();
                            opts[idx].classList.remove('product-list-select-option-active', 'bg-gray-100');
                            opts[idx - 1].classList.add('product-list-select-option-active', 'bg-gray-100');
                            listbox.setAttribute('aria-activedescendant', opts[idx - 1].id || '');
                            opts[idx - 1].scrollIntoView({ block: 'nearest' });
                        } else if (e.key === 'Enter' && current) {
                            e.preventDefault();
                            current.click();
                        }
                    });
                });

                document.addEventListener('click', function(e) {
                    if (openMenu && !openMenu.contains(e.target)) closeAll();
                });
            })();

            document.getElementById('ProductNameFilter')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('filterForm').submit();
                }
            });
        });
    </script>
}
