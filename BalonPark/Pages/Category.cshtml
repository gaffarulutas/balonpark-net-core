@page "/category/{slug}"
@model CategoryModel
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = Model.Category?.Name ?? "Kategori";
    ViewData["Description"] = !string.IsNullOrEmpty(Model.Category?.Description) 
        ? $"{Model.Category.Name} - {Model.Category.Description} | {companyName}"
        : $"{Model.Category?.Name} şişme oyun grupları ve oyuncakları. {companyName}'ta kaliteli şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları.";
    ViewData["Keywords"] = $"{Model.Category?.Name}, şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları, balon park, çocuk oyun grupları";
    ViewData["Image"] = settings?.Logo != null ? (((IUrlService?)ViewData["UrlService"])?.GetImageUrl(settings.Logo) ?? settings.Logo) : (((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/logo/logo.png");
}

<!-- Category Structured Data -->
@if (Model.Category != null)
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@Html.Raw(Model.Category.Name)",
        "description": "@Html.Raw(Model.Category.Description ?? Model.Category.Name + " şişme oyun grupları ve oyuncakları")",
        "url": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.Category.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Category.Slug}")",
        "mainEntity": {
            "@@type": "ItemList",
            "name": "@Html.Raw(Model.Category.Name) Ürünleri",
            "description": "@Html.Raw(Model.Category.Description ?? Model.Category.Name + " kategorisindeki tüm ürünler")",
            "numberOfItems": "@Model.TotalProducts",
            "itemListElement": [
                @{
                    int itemCount = 0;
                    int maxItems = 10;
                    foreach (var subCategoryGroup in Model.ProductsBySubCategory)
                    {
                        foreach (var productWithImage in subCategoryGroup.Value.Take(maxItems - itemCount))
                        {
                            if (itemCount >= maxItems) break;
                            var product = productWithImage.Product;
                            @: {
                            @:     "@@type": "ListItem",
                            @:     "position": @(itemCount + 1),
                            @:     "item": {
                            @:         "@@type": "Product",
                            @:         "name": "@Html.Raw(product.Name)",
                            @:         "description": "@Html.Raw(product.Description ?? product.Name)",
                            @:         "url": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Category.Slug, product.SubCategorySlug ?? "", product.Slug) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Category.Slug}/{product.SubCategorySlug}/{product.Slug}")",
                            @:         "image": "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png")}")",
                            @:         "offers": {
                            @:             "@@type": "Offer",
                            @:             "price": "@product.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)",
                            @:             "priceCurrency": "TRY",
                            @:             "availability": "@(product.Stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")"
                            @:         }
                            @:     }
                            @: }@(itemCount < maxItems - 1 ? "," : "")
                            itemCount++;
                        }
                        if (itemCount >= maxItems) break;
                    }
                }
            ]
        },
        "breadcrumb": {
            "@@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@@type": "ListItem",
                    "position": 1,
                    "name": "Ana Sayfa",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl("/") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/")"
                },
                {
                    "@@type": "ListItem",
                    "position": 2,
                    "name": "@Html.Raw(Model.Category.Name)",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.Category.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Category.Slug}")"
                }
            ]
        }
    }
    </script>
}


<!-- Category Section Start -->
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-1.5 text-sm text-gray-500" aria-label="Breadcrumb">
        <a href="/" class="text-ink hover:text-primary transition">Ana Sayfa</a>
        <span>/</span>
        <span class="text-ink font-medium">@Html.Raw(Model.Category?.Name)</span>
    </nav>

    @if (Model.SubCategories.Any())
    {
        <!-- Alt kategoriler (grid, swiper yerine) -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
            @foreach (var subCategory in Model.SubCategories)
            {
                <a href="/category/@Model.Category?.Slug/@subCategory.Slug" class="group bg-white rounded border border-gray-100 overflow-hidden hover:border-gray-200 hover:bg-gray-50/50 transition-all duration-200 flex flex-col">
                    <div class="aspect-square bg-gray-50 overflow-hidden">
                        @if (!string.IsNullOrEmpty(subCategory.FirstProductImage))
                        {
                            <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(subCategory.FirstProductImage) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{subCategory.FirstProductImage}")" alt="@Html.Raw(subCategory.Name)" class="lazy-image w-full h-full object-cover group-hover:opacity-95 transition-opacity duration-200" loading="lazy">
                        }
                        else
                        {
                            <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")" alt="@Html.Raw(subCategory.Name)" class="lazy-image w-full h-full object-cover" loading="lazy">
                        }
                    </div>
                    <div class="p-3 border-t border-gray-100">
                        <span class="font-medium text-sm text-ink group-hover:text-primary transition">@Html.Raw(subCategory.Name)</span>
                        @if (!string.IsNullOrEmpty(subCategory.Description))
                        {
                            <p class="text-xs text-gray-500 mt-0.5 line-clamp-2">@Html.Raw(subCategory.Description)</p>
                        }
                        <p class="text-xs text-gray-400 mt-1">@subCategory.ProductCount ürün</p>
                    </div>
                </a>
            }
        </div>
    }

    @if (Model.SubCategories.Any())
    {
        @foreach (var subCategory in Model.SubCategories)
        {
            <div class="pt-2 pb-4 border-b border-gray-100 last:border-b-0">
                <div class="mb-3">
                    <h2 class="text-ink text-base font-medium">@Html.Raw(subCategory.Name) <span class="text-gray-400 font-normal">(@subCategory.ProductCount ürün)</span></h2>
                    @if (!string.IsNullOrEmpty(subCategory.Description))
                    {
                        <p class="text-xs text-gray-500 mt-0.5">@Html.Raw(subCategory.Description)</p>
                    }
                </div>

                @if (Model.ProductsBySubCategory.ContainsKey(subCategory.Slug) && Model.ProductsBySubCategory[subCategory.Slug].Any())
                {
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        @foreach (var item in Model.ProductsBySubCategory[subCategory.Slug])
                        {
                            @await Html.PartialAsync("Shared/_ProductCard", new ProductCardViewModel { Item = item, SelectedCurrency = Model.SelectedCurrency })
                        }
                    </div>

                    @if (subCategory.ProductCount > Model.MaxProductsPerSubCategory)
                    {
                        <div class="text-center mt-4">
                            <a href="/category/@Model.Category?.Slug/@subCategory.Slug" class="inline-flex items-center gap-2 py-2 px-4 rounded border border-gray-200 text-sm text-ink hover:bg-gray-50 hover:border-primary hover:text-primary transition">
                                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                Tümünü Gör (@subCategory.ProductCount ürün)
                            </a>
                            <p class="text-xs text-gray-400 mt-1.5">@Model.MaxProductsPerSubCategory / @subCategory.ProductCount ürün gösteriliyor</p>
                        </div>
                    }
                }
                else
                {
                    <p class="text-sm text-gray-500 py-4">Bu alt kategoride henüz ürün bulunmamaktadır.</p>
                }
            </div>
        }
    }
    else
    {
        <div class="rounded border border-gray-100 bg-gray-50 py-12 px-4 text-center">
            <h3 class="text-base font-medium text-ink">Alt kategori bulunmamaktadır</h3>
            <p class="text-sm text-gray-500 mt-1">Lütfen daha sonra tekrar kontrol edin.</p>
        </div>
    }
</div>
