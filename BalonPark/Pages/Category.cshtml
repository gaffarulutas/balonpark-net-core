@page "/category/{slug}"
@model CategoryModel
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = Model.Category?.Name ?? "Kategori";
    ViewData["Description"] = !string.IsNullOrEmpty(Model.Category?.Description) 
        ? $"{Model.Category.Name} - {Model.Category.Description} | {companyName}"
        : $"{Model.Category?.Name} şişme oyun grupları ve oyuncakları. {companyName}'ta kaliteli şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları.";
    ViewData["Keywords"] = $"{Model.Category?.Name}, şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları, ünlü park, çocuk oyun grupları";
    ViewData["Image"] = settings?.Logo != null ? (((IUrlService?)ViewData["UrlService"])?.GetImageUrl(settings.Logo) ?? settings.Logo) : (((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/logo/logo.png");
}

<!-- Category Structured Data -->
@if (Model.Category != null)
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@Html.Raw(Model.Category.Name)",
        "description": "@Html.Raw(Model.Category.Description ?? Model.Category.Name + " şişme oyun grupları ve oyuncakları")",
        "url": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.Category.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Category.Slug}")",
        "mainEntity": {
            "@@type": "ItemList",
            "name": "@Html.Raw(Model.Category.Name) Ürünleri",
            "description": "@Html.Raw(Model.Category.Description ?? Model.Category.Name + " kategorisindeki tüm ürünler")",
            "numberOfItems": "@Model.TotalProducts",
            "itemListElement": [
                @{
                    int itemCount = 0;
                    int maxItems = 10;
                    foreach (var subCategoryGroup in Model.ProductsBySubCategory)
                    {
                        foreach (var productWithImage in subCategoryGroup.Value.Take(maxItems - itemCount))
                        {
                            if (itemCount >= maxItems) break;
                            var product = productWithImage.Product;
                            @: {
                            @:     "@@type": "ListItem",
                            @:     "position": @(itemCount + 1),
                            @:     "item": {
                            @:         "@@type": "Product",
                            @:         "name": "@Html.Raw(product.Name)",
                            @:         "description": "@Html.Raw(product.Description ?? product.Name)",
                            @:         "url": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.Category.Slug, product.SubCategorySlug ?? "", product.Slug) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Category.Slug}/{product.SubCategorySlug}/{product.Slug}")",
                            @:         "image": "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png")}")",
                            @:         "offers": {
                            @:             "@@type": "Offer",
                            @:             "price": "@product.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)",
                            @:             "priceCurrency": "TRY",
                            @:             "availability": "@(product.Stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")"
                            @:         }
                            @:     }
                            @: }@(itemCount < maxItems - 1 ? "," : "")
                            itemCount++;
                        }
                        if (itemCount >= maxItems) break;
                    }
                }
            ]
        },
        "breadcrumb": {
            "@@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@@type": "ListItem",
                    "position": 1,
                    "name": "Ana Sayfa",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl("/") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/")"
                },
                {
                    "@@type": "ListItem",
                    "position": 2,
                    "name": "@Html.Raw(Model.Category.Name)",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.Category.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.Category.Slug}")"
                }
            ]
        }
    }
    </script>
}


<!-- Category Section Start -->
<div class="section-b-space">
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <div class="breadcrumb-container">
            <a href="/" class="breadcrumb-item">
                <i class="fas fa-home"></i>
                <span>Ana Sayfa</span>
            </a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">@Html.Raw(Model.Category?.Name)</span>
        </div>
    </nav>

        @if (Model.SubCategories.Any())
        {
            <div class="swiper categorySwiper">
                <div class="swiper-wrapper">
                    @foreach (var subCategory in Model.SubCategories)
                    {
                        <div class="swiper-slide">
                            <div class="ui card">
                                @if (!string.IsNullOrEmpty(subCategory.FirstProductImage))
                                {
                                    <div class="image">
                                        <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(subCategory.FirstProductImage) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{subCategory.FirstProductImage}")" alt="@Html.Raw(subCategory.Name)" class="subcategory-thumbnail">
                                    </div>
                                }
                                else
                                {
                                    <div class="image">
                                        <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")" alt="@Html.Raw(subCategory.Name)" class="subcategory-thumbnail">
                                    </div>
                                }
                                <div class="content">
                                    <div class="header">
                                        <a href="/category/@Model.Category?.Slug/@subCategory.Slug">
                                            @Html.Raw(subCategory.Name)
                                        </a>
                                    </div>
                                    @if (!string.IsNullOrEmpty(subCategory.Description))
                                    {
                                        <div class="description">
                                            @Html.Raw(subCategory.Description)
                                        </div>
                                    }
                                </div>
                                <div class="extra content">
                                    <a href="/category/@Model.Category?.Slug/@subCategory.Slug" class="ui primary button">
                                        <i class="shopping bag icon"></i>
                                        @Html.Raw(subCategory.Name) (<b>@subCategory.ProductCount</b> ürün)
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        }

        @if (Model.SubCategories.Any())
        {
            @foreach (var subCategory in Model.SubCategories)
            {
                <div class="modern-subcategory-section mb-5">
                    <div class="modern-subcategory-header mb-4">
                        <h3 class="modern-subcategory-title">@Html.Raw(subCategory.Name) (@subCategory.ProductCount ürün)</h3>
                        @if (!string.IsNullOrEmpty(subCategory.Description))
                        {
                            <p class="modern-subcategory-description">@Html.Raw(subCategory.Description)</p>
                        }
                    </div>
                    
                    @if (Model.ProductsBySubCategory.ContainsKey(subCategory.Slug) && Model.ProductsBySubCategory[subCategory.Slug].Any())
                    {
                        <div class="row row-cols-xxl-6 row-cols-lg-5 row-cols-md-4 row-cols-sm-3 row-cols-2 g-sm-4 g-3">
                            @foreach (var item in Model.ProductsBySubCategory[subCategory.Slug])
                            {
                                <div>
                                    <div class="product-box modern-product-card wow fadeIn">
                                        <!-- Product Actions -->
                                        <div class="product-actions">
                                            <button class="favorite-btn" data-product-id="@item.Product.Id">
                                                <i class="fa-regular fa-heart"></i>
                                                <span class="btn-text">Favori</span>
                                            </button>
                                            <button class="compare-btn" data-product-id="@item.Product.Id">
                                                <i class="fa-solid fa-shuffle"></i>
                                                <span class="btn-text">Karşılaştır</span>
                                            </button>
                                        </div>

                                        <div class="product-image">
                                            <a href="/category/@item.Product.CategorySlug/@item.Product.SubCategorySlug/@item.Product.Slug">
                                                @if (item.MainImage != null)
                                                {
                                                    <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(item.MainImage.ThumbnailPath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{item.MainImage.ThumbnailPath}")" class="img-fluid blur-up lazyload product-thumbnail" alt="@Html.Raw(item.Product.Name)">
                                                }
                                                else
                                                {
                                                    <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")" class="img-fluid blur-up lazyload product-thumbnail" alt="@Html.Raw(item.Product.Name)">
                                                }
                                            </a>
                                        </div>
                                        <div class="product-detail position-relative">
                                            <a href="/category/@item.Product.CategorySlug/@item.Product.SubCategorySlug/@item.Product.Slug">
                                                <h6 class="name">@Html.Raw(item.Product.Name)</h6>
                                            </a>

                                            <h6 class="sold weight text-content fw-normal">@Html.Raw(item.Product.CategoryName)</h6>

                                            @if (!string.IsNullOrEmpty(item.Product.Description))
                                            {
                                                <p class="product-description text-content">
                                                    @Html.Raw(item.Product.Description.Length > 60 ? item.Product.Description.Substring(0, 60) + "..." : item.Product.Description)
                                                </p>
                                            }

                                            @if (!string.IsNullOrEmpty(item.Product.Dimensions))
                                            {
                                                <div class="product-dimensions">
                                                    <i class="fa-solid fa-ruler-combined"></i>
                                                    <span class="dimensions-text">@Html.Raw(item.Product.Dimensions)</span>
                                                </div>
                                            }

                                            <div class="price-section">
                                                @if (item.Product.Price <= 0)
                                                {
                                                    <p class="price-contact-text">Fiyat için iletişime geçin</p>
                                                }
                                                else
                                                {
                                                    <h6 class="price price-tl @(Model.SelectedCurrency == "TL" ? "active" : "")" style="color: #6262a6;">₺@item.Product.Price.ToString("N2")</h6>
                                                    <h6 class="price price-usd @(Model.SelectedCurrency == "USD" ? "active" : "")" style="color: #6262a6;">$@item.Product.UsdPrice.ToString("N2")</h6>
                                                    <h6 class="price price-eur @(Model.SelectedCurrency == "EUR" ? "active" : "")" style="color: #6262a6;">€@item.Product.EuroPrice.ToString("N2")</h6>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        @* Tümünü Gör Butonu - Eğer gösterilenden fazla ürün varsa *@
                        @if (subCategory.ProductCount > Model.MaxProductsPerSubCategory)
                        {
                            <div class="text-center mt-4">
                                <a href="/category/@Model.Category?.Slug/@subCategory.Slug" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-arrow-right"></i>
                                    Tümünü Gör (@subCategory.ProductCount ürün)
                                </a>
                                <small class="d-block mt-2 text-muted">
                                    (@Model.MaxProductsPerSubCategory / @subCategory.ProductCount ürün gösteriliyor)
                                </small>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-products">
                            <p class="text-muted">Bu alt kategoride henüz ürün bulunmamaktadır.</p>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <h5>Alt kategori bulunmamaktadır</h5>
                        <p>Lütfen daha sonra tekrar kontrol edin</p>
                    </div>
                </div>
            </div>
        }

        @* Ana kategoride pagination kaldırıldı - Her alt kategoride max 36 ürün gösteriliyor *@
 
</div>

@section Styles {
    <style>

        .product-dimensions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0;
            padding: 4px 8px;
            background: rgba(98, 98, 166, 0.1);
            border-radius: 6px;
            font-size: 12px;
            color: #6262a6;
            font-weight: 500;
        }

        .product-dimensions i {
            font-size: 11px;
            color: #6262a6;
        }

        .dimensions-text {
            font-size: 11px;
            color: #6262a6;
            font-weight: 500;
        }

        .modern-product-card .product-dimensions {
            margin: 6px 0;
            padding: 3px 6px;
            background: rgba(98, 98, 166, 0.08);
            border-radius: 4px;
        }

        .modern-product-card .product-dimensions i {
            font-size: 10px;
        }

        .modern-product-card .dimensions-text {
            font-size: 10px;
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .product-dimensions {
                margin: 6px 0;
                padding: 3px 6px;
                font-size: 11px;
            }
            
            .product-dimensions i {
                font-size: 10px;
            }
            
            .dimensions-text {
                font-size: 10px;
            }
        }

        /* Swiper Category Slider */
        .categorySwiper {
            padding: 20px 0;
            z-index: 0;
        }

        .categorySwiper .swiper-slide {
            width: 25%; /* 4 items per view */
        }

        .categorySwiper .ui.card {
            margin: 0; /* Remove default margin */
            width: auto; /* Full width cards */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .categorySwiper .ui.card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .categorySwiper .ui.card .image {
            width: auto;
        }

        .categorySwiper .ui.card .content {
            width: auto;
            padding: 15px;
        }

        .categorySwiper .ui.card .extra.content {
            width: auto;
            padding: 15px;
        }

        @@media (max-width: 1200px) {
            .categorySwiper .swiper-slide {
                width: 33.333%; /* 3 items per view */
            }
        }

        @@media (max-width: 768px) {
            .categorySwiper .swiper-slide {
                width: 50%; /* 2 items per view */
            }
        }

        @@media (max-width: 576px) {
            .categorySwiper .swiper-slide {
                width: 100%; /* 1 item per view */
            }
        }

        /* Tümünü Gör Butonu Stilleri */
        .btn-outline-primary {
            border: 2px solid #6262a6;
            color: #6262a6;
            font-weight: 600;
            padding: 12px 32px;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-outline-primary:hover {
            background-color: #6262a6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(98, 98, 166, 0.3);
            text-decoration: none;
        }

        .btn-outline-primary i {
            transition: transform 0.3s ease;
        }

        .btn-outline-primary:hover i {
            transform: translateX(5px);
        }

        .btn-lg {
            font-size: 16px;
            padding: 14px 36px;
        }

        @@media (max-width: 768px) {
            .btn-lg {
                font-size: 14px;
                padding: 10px 24px;
            }
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Category Swiper
            const categorySwiper = new Swiper('.categorySwiper', {
                slidesPerView: 4,
                spaceBetween: 20, // Item spacing
                loop: false,

                autoplay: false,
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                breakpoints: {
                    1200: {
                        slidesPerView: 4,
                        spaceBetween: 20,
                    },
                    768: {
                        slidesPerView: 3,
                        spaceBetween: 15,
                    },
                    576: {
                        slidesPerView: 2,
                        spaceBetween: 10,
                    },
                    320: {
                        slidesPerView: 1,
                        spaceBetween: 10,
                    }
                }
            });
        });
    </script>
}