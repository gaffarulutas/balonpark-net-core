@page
@model BalonPark.Pages.Admin.Products.CreateModel
@using BalonPark.Models
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Yeni Ürün";
    var inputClass = "w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent";
}
<!-- Header -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Yeni Ürün Ekle
            </h1>
            <p class="text-gray-600 mt-2">Yeni bir ürün oluşturun</p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="/admin/products" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Geri Dön
            </a>
        </div>
    </div>
</div>

<!-- Form - Tek kart içinde tüm alanlar -->
<div class="bg-white rounded-lg shadow-md p-8">
    <form method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()

        <div class="space-y-8">
            <!-- Ürün Görselleri -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Ürün Görselleri
                </h2>
                <p class="text-sm text-gray-500 mb-4">İlk eklenen resim ana kapak resmi olur.</p>
                <div id="imageDropZone" class="relative flex flex-col items-center justify-center px-6 py-12 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50/80 hover:bg-gray-100/80 hover:border-gray-400 focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 transition-colors duration-200">
                    <input type="file" id="productImagesInput" name="Images" accept="image/jpeg,image/png,image/webp,image/gif" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" aria-label="Ürün resimleri seçin">
                    <svg class="mx-auto h-14 w-14 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <p class="mt-2 text-base text-gray-600 text-center pointer-events-none">
                        <span class="font-medium text-gray-900">Dosya seçin</span> veya sürükleyip bırakın
                    </p>
                    <p class="mt-1 text-sm text-gray-500 pointer-events-none">PNG, JPG, WebP, GIF — dosya başına en fazla 10 MB</p>
                </div>
                <div id="imagePreviewContainer" class="mt-4 hidden" aria-live="polite">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Yüklenecek resimler (<span id="imagePreviewCount">0</span>)</h3>
                    <div id="imagePreviewGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
                    <button type="button" id="imageClearBtn" class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium">Seçimi temizle</button>
                </div>
            </div>

            <!-- Temel Bilgiler -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Temel Bilgiler</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label asp-for="Product.CategoryId" class="block text-sm font-medium text-gray-700 mb-2">Kategori <span class="text-red-500">*</span></label>
                            <select asp-for="Product.CategoryId" id="categoryDropdown" class="@inputClass">
                                <option value="0">Kategori seçin...</option>
                                @foreach (var category in Model.Categories)
                                {
                                    <option value="@category.Id">@Html.Raw(category.Name)</option>
                                }
                            </select>
                            <span asp-validation-for="Product.CategoryId" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                        <div>
                            <label asp-for="Product.SubCategoryId" class="block text-sm font-medium text-gray-700 mb-2">Alt Kategori <span class="text-red-500">*</span></label>
                            <select asp-for="Product.SubCategoryId" id="subCategoryDropdown" class="@inputClass">
                                <option value="0">Önce kategori seçin...</option>
                            </select>
                            <span asp-validation-for="Product.SubCategoryId" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                    </div>
                    <div>
                        <label asp-for="Product.Name" class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı <span class="text-red-500">*</span> <span class="text-gray-500 font-normal">(max @Product.NameMaxLength karakter)</span></label>
                        <input type="text" asp-for="Product.Name" maxlength="@Product.NameMaxLength" class="@inputClass" placeholder="Örn: Şişme Oyun Parkı 5x5">
                        <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.NameMaxLength">0 / @Product.NameMaxLength</span>
                        <span asp-validation-for="Product.Name" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>

            <!-- Fiyat ve Stok -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Fiyat ve Stok</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label asp-for="Product.Price" class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺) <span class="text-red-500">*</span></label>
                        <input type="number" asp-for="Product.Price" step="0.01" min="0" class="@inputClass input-select-all" placeholder="0.00">
                        <span asp-validation-for="Product.Price" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    <div>
                        <label asp-for="Product.Stock" class="block text-sm font-medium text-gray-700 mb-2">Stok <span class="text-red-500">*</span></label>
                        <input type="number" asp-for="Product.Stock" min="0" class="@inputClass input-select-all" placeholder="0">
                        <span asp-validation-for="Product.Stock" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>

            <!-- İçerik ve Açıklamalar -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">İçerik ve Açıklamalar</h2>
                <div class="space-y-4">
                    <div>
                        <label asp-for="Product.Description" class="block text-sm font-medium text-gray-700 mb-2">Açıklama (En az 140 karakter) <span class="text-red-500">*</span></label>
                        <textarea asp-for="Product.Description" id="productDescription" rows="5" class="@inputClass" placeholder="Ürün hakkında detaylı açıklama..."></textarea>
                        <div class="mt-2 text-sm text-gray-500"><span id="charCount">0</span> / 140 karakter (minimum)</div>
                        <span asp-validation-for="Product.Description" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    <div>
                        <label asp-for="Product.Summary" class="block text-sm font-medium text-gray-700 mb-2">Özet <span class="text-gray-500 font-normal">(max @Product.SummaryMaxLength karakter)</span></label>
                        <textarea asp-for="Product.Summary" maxlength="@Product.SummaryMaxLength" rows="3" class="@inputClass" placeholder="Kısa özet (isteğe bağlı)"></textarea>
                        <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.SummaryMaxLength">0 / @Product.SummaryMaxLength</span>
                        <small class="text-gray-500 text-sm mt-1 block">Kart ve detay sayfasında görünür.</small>
                    </div>
                    <div>
                        <label asp-for="Product.TechnicalDescription" class="block text-sm font-medium text-gray-700 mb-2">Teknik Açıklama (HTML)</label>
                        <textarea asp-for="Product.TechnicalDescription" id="technicalDescriptionEditor" rows="8" class="@inputClass" placeholder="Teknik özellikler, HTML kullanılabilir..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Ürün Teknik Bilgileri -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Ürün Teknik Bilgileri</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Şişmiş Ürün Ölçüleri</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label asp-for="Product.InflatedLength" class="block text-sm font-medium text-gray-700 mb-2">Uzunluk (m)</label>
                                <input type="number" asp-for="Product.InflatedLength" step="1" min="0" class="@inputClass" placeholder="Örn: 12">
                            </div>
                            <div>
                                <label asp-for="Product.InflatedWidth" class="block text-sm font-medium text-gray-700 mb-2">Genişlik (m)</label>
                                <input type="number" asp-for="Product.InflatedWidth" step="1" min="0" class="@inputClass" placeholder="Örn: 3">
                            </div>
                            <div>
                                <label asp-for="Product.InflatedHeight" class="block text-sm font-medium text-gray-700 mb-2">Yükseklik (m)</label>
                                <input type="number" asp-for="Product.InflatedHeight" step="1" min="0" class="@inputClass" placeholder="Örn: 3">
                            </div>
                            <div>
                                <label asp-for="Product.UserCount" class="block text-sm font-medium text-gray-700 mb-2">Kullanıcı Sayısı</label>
                                <input type="number" asp-for="Product.UserCount" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Montaj ve Demontaj</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label asp-for="Product.AssemblyTime" class="block text-sm font-medium text-gray-700 mb-2">Montaj / Demontaj Süresi (saat)</label>
                                <input type="number" asp-for="Product.AssemblyTime" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                            <div>
                                <label asp-for="Product.RequiredPersonCount" class="block text-sm font-medium text-gray-700 mb-2">Gerekli Kişi Sayısı</label>
                                <input type="number" asp-for="Product.RequiredPersonCount" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                            <div>
                                <label asp-for="Product.FanDescription" class="block text-sm font-medium text-gray-700 mb-2">Fan Açıklaması <span class="text-gray-500 font-normal">(max @Product.FanDescriptionMaxLength)</span></label>
                                <input type="text" asp-for="Product.FanDescription" maxlength="@Product.FanDescriptionMaxLength" class="@inputClass" placeholder="Örn: 1 x türbin">
                                <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.FanDescriptionMaxLength">0 / @Product.FanDescriptionMaxLength</span>
                            </div>
                            <div>
                                <label asp-for="Product.FanWeightKg" class="block text-sm font-medium text-gray-700 mb-2">Fan Ağırlığı (kg)</label>
                                <input type="number" asp-for="Product.FanWeightKg" step="1" min="0" class="@inputClass" placeholder="Örn: 20">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Paketlenmiş Ürün Özellikleri</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label asp-for="Product.PackagedLength" class="block text-sm font-medium text-gray-700 mb-2">Uzunluk (cm)</label>
                                <input type="number" asp-for="Product.PackagedLength" step="1" min="0" class="@inputClass" placeholder="Örn: 80">
                            </div>
                            <div>
                                <label asp-for="Product.PackagedDepth" class="block text-sm font-medium text-gray-700 mb-2">Derinlik (cm)</label>
                                <input type="number" asp-for="Product.PackagedDepth" step="1" min="0" class="@inputClass" placeholder="Örn: 70">
                            </div>
                            <div>
                                <label asp-for="Product.PackagedWeightKg" class="block text-sm font-medium text-gray-700 mb-2">Ağırlık (kg)</label>
                                <input type="number" asp-for="Product.PackagedWeightKg" step="1" min="0" class="@inputClass" placeholder="Örn: 95">
                            </div>
                            <div>
                                <label asp-for="Product.PackagePalletCount" class="block text-sm font-medium text-gray-700 mb-2">Paket / Palet Sayısı</label>
                                <input type="number" asp-for="Product.PackagePalletCount" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Sertifika ve Garanti</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label asp-for="Product.WarrantyDescription" class="block text-sm font-medium text-gray-700 mb-2">Garanti Süresi <span class="text-gray-500 font-normal">(max @Product.WarrantyDescriptionMaxLength)</span></label>
                                <input type="text" asp-for="Product.WarrantyDescription" maxlength="@Product.WarrantyDescriptionMaxLength" class="@inputClass" placeholder="Örn: 2 yıl garanti">
                                <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.WarrantyDescriptionMaxLength">0 / @Product.WarrantyDescriptionMaxLength</span>
                            </div>
                            <div>
                                <label asp-for="Product.AfterSalesService" class="block text-sm font-medium text-gray-700 mb-2">Garanti Sonrası Hizmet <span class="text-gray-500 font-normal">(max @Product.AfterSalesServiceMaxLength)</span></label>
                                <input type="text" asp-for="Product.AfterSalesService" maxlength="@Product.AfterSalesServiceMaxLength" class="@inputClass" placeholder="Örn: 5 yıllık servis ve bakım desteği">
                                <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.AfterSalesServiceMaxLength">0 / @Product.AfterSalesServiceMaxLength</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ürün Etiketleri ve Detay Özellikleri -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Ürün Etiketleri ve Detay Özellikleri</h2>
                <p class="text-sm text-gray-500 mb-4">Bu alanlar ürün detay sayfasında etiket ve özellik etiketleri olarak gösterilir.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Teslimat süresi (iş günü)</label>
                        <div class="flex items-center gap-2 flex-wrap">
                            <input type="number" asp-for="Product.DeliveryDaysMin" step="1" min="0" class="w-24 px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent" placeholder="Min">
                            <span class="text-gray-500">–</span>
                            <input type="number" asp-for="Product.DeliveryDaysMax" step="1" min="0" class="w-24 px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent" placeholder="Max">
                            <span class="text-sm text-gray-500">iş günü</span>
                        </div>
                    </div>
                    <div>
                        <label asp-for="Product.MaterialWeightGrm2" class="block text-sm font-medium text-gray-700 mb-2">Kumaş ağırlığı (gr/m²)</label>
                        <input type="number" asp-for="Product.MaterialWeightGrm2" step="1" min="0" class="@inputClass" placeholder="Örn: 650">
                    </div>
                    <div>
                        <label asp-for="Product.InflatedWeightKg" class="block text-sm font-medium text-gray-700 mb-2">Şişmiş ürün ağırlığı (kg)</label>
                        <input type="number" asp-for="Product.InflatedWeightKg" step="1" min="0" class="@inputClass" placeholder="Örn: 95">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Renk seçenekleri</label>
                        <input type="hidden" asp-for="Product.ColorOptions" id="Product_ColorOptions" value="">
                        <div class="flex flex-wrap items-end gap-2 mb-2">
                            <div class="flex items-center gap-2">
                                <input type="color" id="color-picker-input" value="#1e3a5f" class="h-11 w-16 cursor-pointer rounded border border-gray-300 bg-gray-50 p-1">
                                <input type="text" id="color-name-input" placeholder="Renk adı (isteğe bağlı)" class="w-44 px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800" maxlength="50">
                                <button type="button" id="color-add-btn" class="inline-flex items-center gap-1 px-4 py-3 rounded-lg bg-gray-800 text-white text-base font-medium hover:bg-gray-700">Ekle</button>
                            </div>
                        </div>
                        <div id="color-list" class="flex flex-wrap gap-2 min-h-[2.5rem] p-3 border border-gray-200 rounded-lg bg-gray-50/50"></div>
                        <p class="mt-1 text-xs text-gray-500">Renk seçin, isteğe bağlı ad yazın ve Ekle'ye tıklayın.</p>
                    </div>
                </div>
            </div>

            <!-- Seçenekler (tüm checkbox'lar) -->
            <div class="pb-2">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Seçenekler</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" asp-for="Product.IsActive" checked class="w-5 h-5 text-gray-900 border-gray-300 rounded focus:ring-gray-800">
                        <label asp-for="Product.IsActive" class="text-sm font-medium text-gray-700">Ürün aktif (sitede listelenir)</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" asp-for="Product.HasCertificate" class="w-5 h-5 text-gray-900 border-gray-300 rounded focus:ring-gray-800">
                        <label asp-for="Product.HasCertificate" class="text-sm font-medium text-gray-700">Sertifikalı ürün</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" asp-for="Product.IsDiscounted" class="w-5 h-5 text-gray-900 border-gray-300 rounded focus:ring-gray-800">
                        <label asp-for="Product.IsDiscounted" class="text-sm font-medium text-gray-700">İndirimli Ürün</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" asp-for="Product.IsPopular" class="w-5 h-5 text-gray-900 border-gray-300 rounded focus:ring-gray-800">
                        <label asp-for="Product.IsPopular" class="text-sm font-medium text-gray-700">Popüler</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" asp-for="Product.IsProjectSpecial" class="w-5 h-5 text-gray-900 border-gray-300 rounded focus:ring-gray-800">
                        <label asp-for="Product.IsProjectSpecial" class="text-sm font-medium text-gray-700">Projeye özel</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" asp-for="Product.IsFireResistant" class="w-5 h-5 text-gray-900 border-gray-300 rounded focus:ring-gray-800">
                        <label asp-for="Product.IsFireResistant" class="text-sm font-medium text-gray-700">Ateşe dayanıklı</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="border-t border-gray-200 mt-8 pt-6">
            <div class="flex items-center gap-3">
                <button type="submit" class="inline-flex items-center px-6 py-3 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-colors duration-200 shadow-md text-base" data-loading-text="Ürün kaydediliyor...">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    Kaydet
                </button>
                <a href="/admin/products" class="inline-flex items-center px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition-colors duration-200 text-base">İptal</a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
    <script>
        // Fiyat ve Stok: focus/click ile tüm değeri seç
        document.querySelectorAll('.input-select-all').forEach(function(el) {
            el.addEventListener('focus', function() { this.select(); });
            el.addEventListener('click', function() { this.select(); });
        });

        // ----- Ürün resimleri -----
        (function() {
            var MAX_FILE_SIZE_MB = 10;
            var MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
            var dropZone = document.getElementById('imageDropZone');
            var fileInput = document.getElementById('productImagesInput');
            var previewContainer = document.getElementById('imagePreviewContainer');
            var previewGrid = document.getElementById('imagePreviewGrid');
            var previewCountEl = document.getElementById('imagePreviewCount');
            var clearBtn = document.getElementById('imageClearBtn');
            if (!dropZone || !fileInput) return;

            function renderPreviews(files) {
                previewGrid.innerHTML = '';
                if (!files || files.length === 0) {
                    previewContainer.classList.add('hidden');
                    return;
                }
                previewContainer.classList.remove('hidden');
                previewCountEl.textContent = files.length;
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var card = document.createElement('div');
                    card.className = 'relative rounded-lg border-2 border-gray-200 overflow-hidden bg-gray-50 group';
                    var img = document.createElement('img');
                    img.className = 'w-full aspect-square object-cover';
                    img.alt = file.name || '';
                    var reader = new FileReader();
                    reader.onload = (function(el) { return function(e) { el.src = e.target.result; }; })(img);
                    reader.readAsDataURL(file);
                    var overlay = document.createElement('div');
                    overlay.className = 'absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-2';
                    var label = document.createElement('span');
                    label.className = 'text-white text-xs font-medium block truncate';
                    label.textContent = file.name || 'isimsiz';
                    var badge = document.createElement('span');
                    badge.className = 'text-[10px] text-gray-200 mt-0.5 block';
                    badge.textContent = i === 0 ? 'Ana resim' : 'Resim ' + (i + 1);
                    overlay.appendChild(label);
                    overlay.appendChild(badge);
                    card.appendChild(img);
                    card.appendChild(overlay);
                    previewGrid.appendChild(card);
                }
            }

            function handleFiles(fileList) {
                if (!fileList || fileList.length === 0) { renderPreviews([]); return; }
                var files = Array.prototype.slice.call(fileList);
                var valid = [];
                var tooBig = [];
                for (var i = 0; i < files.length; i++) {
                    if (!files[i].type.match(/^image\/(jpeg|png|webp|gif)$/i)) continue;
                    if (files[i].size > MAX_FILE_SIZE_BYTES) { tooBig.push(files[i].name); continue; }
                    valid.push(files[i]);
                }
                if (tooBig.length && typeof showSnackbar === 'function') showSnackbar('Bazı dosyalar ' + MAX_FILE_SIZE_MB + ' MB\'dan büyük olduğu için atlandı: ' + tooBig.join(', '), 'warning');
                if (valid.length === 0) { fileInput.value = ''; renderPreviews([]); return; }
                var dt = new DataTransfer();
                valid.forEach(function(f) { dt.items.add(f); });
                fileInput.files = dt.files;
                renderPreviews(fileInput.files);
            }

            fileInput.addEventListener('change', function() { handleFiles(this.files); });
            clearBtn.addEventListener('click', function() { fileInput.value = ''; renderPreviews([]); });
            dropZone.addEventListener('dragover', function(e) { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('border-gray-500', 'bg-gray-100'); });
            dropZone.addEventListener('dragleave', function(e) { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('border-gray-500', 'bg-gray-100'); });
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-gray-500', 'bg-gray-100');
                var files = e.dataTransfer && e.dataTransfer.files;
                if (files && files.length) handleFiles(files);
            });
        })();

        function updateCharCount() {
            var text = document.getElementById('productDescription').value;
            document.getElementById('charCount').textContent = (text && text.length) || 0;
        }
        document.getElementById('productDescription').addEventListener('input', updateCharCount);
        updateCharCount();

        let editor;
        ClassicEditor.create(document.querySelector('#technicalDescriptionEditor'), {
            toolbar: { items: ['heading', '|', 'bold', 'italic', 'underline', '|', 'bulletedList', 'numberedList', '|', 'outdent', 'indent', '|', 'link', 'insertTable', '|', 'undo', 'redo'] },
            language: 'tr',
            placeholder: 'Ürünün teknik özellikleri ve detaylı açıklaması...'
        }).then(function(editorInstance) { editor = editorInstance; }).catch(function(err) { console.error('CKEditor hatası:', err); });

        $('#categoryDropdown').on('change', function() {
            var categoryId = $(this).val();
            if (categoryId && categoryId != "0") {
                $.ajax({
                    url: window.location.pathname + '?handler=SubCategories&categoryId=' + categoryId,
                    type: 'GET',
                    success: function(data) {
                        var dropdown = $('#subCategoryDropdown');
                        dropdown.empty().append('<option value="0">Alt kategori seçin...</option>');
                        $.each(data, function(i, item) { dropdown.append('<option value="' + item.id + '">' + item.name + '</option>'); });
                    }
                });
            } else {
                $('#subCategoryDropdown').empty().append('<option value="0">Önce kategori seçin...</option>');
            }
        });

        $('form').on('submit', function(e) {
            var categoryId = $('#categoryDropdown').val();
            var subCategoryId = $('#subCategoryDropdown').val();
            if (!categoryId || categoryId == "0") {
                e.preventDefault();
                if (typeof showSnackbar === 'function') showSnackbar('Lütfen kategori seçin!', 'warning');
                $('#categoryDropdown').focus();
                return false;
            }
            if (!subCategoryId || subCategoryId == "0") {
                e.preventDefault();
                if (typeof showSnackbar === 'function') showSnackbar('Lütfen alt kategori seçin!', 'warning');
                $('#subCategoryDropdown').focus();
                return false;
            }
            if (editor) editor.updateSourceElement();
        });

        $(function() {
            var $colorHidden = $('input[name="Product.ColorOptions"]');
            var $colorPicker = $('#color-picker-input');
            var $colorName = $('#color-name-input');
            var $colorList = $('#color-list');
            var $colorAddBtn = $('#color-add-btn');
            if (!$colorHidden.length || !$colorList.length) return;
            function colorOptionsToArray(val) {
                if (!val || !String(val).trim()) return [];
                return String(val).split(',').map(function(s) { return s.trim(); }).filter(Boolean);
            }
            function colorOptionsFromArray(arr) {
                return (arr && arr.length) ? arr.join(', ') : '';
            }
            function renderColorList() {
                var raw = $colorHidden.val() || '';
                var items = colorOptionsToArray(raw);
                $colorList.empty();
                items.forEach(function(item, idx) {
                    var m = item.match(/^(.+?)\s*\(#([0-9A-Fa-f]{6})\)\s*$/);
                    var namePart = m ? m[1].trim() : item;
                    var hex = m ? '#' + m[2] : null;
                    var displayName = namePart || hex || item;
                    var chipHtml = (hex ? '<span class="w-4 h-4 rounded-full border border-gray-200 flex-shrink-0" style="background-color:' + hex + '"></span>' : '') +
                        '<span class="text-gray-800">' + (displayName || '').replace(/</g, '&lt;') + '</span>' +
                        '<button type="button" class="color-remove ml-0.5 text-gray-400 hover:text-red-600 rounded p-0.5" aria-label="Kaldır" data-idx="' + idx + '">&times;</button>';
                    var $chip = $('<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full border border-gray-200 bg-white text-sm shadow-sm">').html(chipHtml);
                    $chip.find('.color-remove').on('click', function() {
                        var arr = colorOptionsToArray($colorHidden.val());
                        var i = parseInt($(this).data('idx'), 10);
                        if (!isNaN(i) && i >= 0 && i < arr.length) arr.splice(i, 1);
                        $colorHidden.val(colorOptionsFromArray(arr));
                        renderColorList();
                    });
                    $colorList.append($chip);
                });
            }
            if ($colorAddBtn.length && $colorPicker.length) {
                $colorAddBtn.on('click', function() {
                    var hex = ($colorPicker.val() || '').toLowerCase();
                    if (hex && hex.indexOf('#') !== 0) hex = '#' + hex;
                    if (!hex || hex.length < 7) return;
                    var name = ($colorName.val() || '').trim();
                    var entry = name ? (name + ' (#') + hex.replace('#', '') + ')' : hex;
                    var arr = colorOptionsToArray($colorHidden.val());
                    if (arr.indexOf(entry) === -1) arr.push(entry);
                    $colorHidden.val(colorOptionsFromArray(arr));
                    $colorName.val('');
                    renderColorList();
                });
            }
            if ($colorName.length) $colorName.on('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); $colorAddBtn.click(); } });
            renderColorList();
        });
    </script>
}
