@page
@model BalonPark.Pages.Admin.Products.EditModel
@using BalonPark.Models
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Ürün Düzenle";
    var inputClass = "w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent";
}
<!-- Header -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Ürün Düzenle
            </h1>
            <p class="text-gray-600 mt-2">Ürün bilgilerini güncelleyin</p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="/admin/products" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Geri Dön
            </a>
        </div>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 rounded-r-lg">
        <div class="flex items-center">
            <svg class="w-6 h-6 text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div>
                <p class="font-semibold text-green-800">Başarılı!</p>
                <p class="text-green-700">@TempData["SuccessMessage"]</p>
            </div>
        </div>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded-r-lg">
        <div class="flex items-center">
            <svg class="w-6 h-6 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div>
                <p class="font-semibold text-red-800">Hata!</p>
                <p class="text-red-700">@TempData["ErrorMessage"]</p>
            </div>
        </div>
    </div>
}

<!-- Tek kart: Ürün Görselleri en üstte, sonra form -->
<div class="bg-white rounded-lg shadow-md p-8">
    <!-- 1. Ürün Görselleri (en üstte) -->
    <div class="pb-8 border-b border-gray-200 mb-8">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Ürün Görselleri
        </h2>
        @if (Model.ProductImages.Any())
        {
            <p class="text-sm text-gray-500 mb-4">Mevcut resimler. Ana resim yapmak veya silmek için resmin üzerine gelin.</p>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                @foreach (var image in Model.ProductImages)
                {
                    <div class="relative group bg-gray-50 rounded-lg overflow-hidden border-2 @(image.IsMainImage ? "border-gray-800 ring-2 ring-gray-200" : "border-gray-200")">
                        <img src="/@image.ThumbnailPath" class="w-full h-40 object-cover" alt="Product Image" loading="lazy" />
                        @if (image.IsMainImage)
                        {
                            <div class="absolute top-2 left-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-900 text-white shadow-lg">Ana Resim</span>
                            </div>
                        }
                        <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <div class="flex gap-2">
                                @if (!image.IsMainImage)
                                {
                                    <form method="post" asp-page-handler="SetMainImage" asp-route-imageId="@image.Id" asp-route-productId="@Model.Product.Id" class="flex-1">
                                        <button type="submit" class="w-full inline-flex items-center justify-center px-2 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-medium rounded transition-colors" data-loading-text="Ana resim yapılıyor...">Ana Yap</button>
                                    </form>
                                }
                                <form method="post" asp-page-handler="DeleteImage" asp-route-imageId="@image.Id" asp-route-productId="@Model.Product.Id" class="delete-image-form flex-1">
                                    <button type="button" class="delete-image-btn w-full inline-flex items-center justify-center px-2 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-medium rounded transition-colors" data-loading-text="Resim siliniyor...">Sil</button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        <p class="text-sm text-gray-500 mb-2">@(Model.ProductImages.Any() ? "Yeni resim ekleyin:" : "Ürün resimleri yükleyin:")</p>
        <form method="post" enctype="multipart/form-data" id="productEditForm">
            <input type="hidden" asp-for="Product.Id" />
            <input type="hidden" asp-for="Product.CreatedAt" />
            <div id="editImageDropZone" class="flex justify-center px-6 py-12 border-2 border-gray-300 border-dashed rounded-xl bg-gray-50/80 hover:border-gray-400 hover:bg-gray-100/80 transition-colors duration-200 cursor-pointer relative">
                <input type="file" id="editNewImagesInput" name="NewImages" accept="image/jpeg,image/png,image/webp,image/gif" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" aria-label="Yeni ürün resimleri seçin">
                <div class="space-y-1 text-center pointer-events-none">
                    <svg class="mx-auto h-14 w-14 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-base text-gray-600"><span class="font-medium text-gray-900">Dosya seçin</span> veya sürükleyip bırakın</p>
                    <p class="text-sm text-gray-500">PNG, JPG, WebP, GIF – 10MB'a kadar. Birden fazla seçebilirsiniz.</p>
                </div>
            </div>
            <div id="editImagePreviewContainer" class="mt-4 hidden" aria-live="polite">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Yüklenecek resimler (<span id="editImagePreviewCount">0</span>)</h3>
                <div id="editImagePreviewGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
                <button type="button" id="editImageClearBtn" class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium">Seçimi temizle</button>
            </div>

        <div class="space-y-8 mt-8">
            <!-- Temel Bilgiler -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Temel Bilgiler</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        @{
                            var selectedCategoryName = Model.Categories.FirstOrDefault(c => c.Id == Model.Product.CategoryId)?.Name ?? "Kategori seçin...";
                            var selectedSubCategoryName = Model.SubCategories.FirstOrDefault(s => s.Id == Model.Product.SubCategoryId)?.Name ?? "Alt kategori seçin...";
                        }
                        <div>
                            <label asp-for="Product.CategoryId" class="block text-sm font-medium text-gray-700 mb-2">Kategori <span class="text-red-500">*</span></label>
                            <input type="hidden" asp-for="Product.CategoryId" id="categoryHidden" />
                            <div class="relative product-select-wrapper" data-select="category">
                                <button type="button" id="categorySelectBtn" class="product-select-btn w-full h-12 px-4 pr-10 text-left rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-900 shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent flex items-center" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="block truncate" id="categorySelectText">@Html.Raw(selectedCategoryName)</span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                        <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd" /></svg>
                                    </span>
                                </button>
                                <div id="categoryDropdownPanel" class="hidden absolute z-50 mt-1 w-full rounded-lg bg-white py-1 shadow-xl ring-1 ring-black ring-opacity-5 border border-gray-200">
                                    <div class="px-2 py-1.5 border-b border-gray-100">
                                        <input type="text" id="categorySearch" placeholder="Kategori ara..." class="w-full px-3 py-2 text-sm border border-gray-200 rounded-md focus:ring-2 focus:ring-gray-800 focus:border-transparent" autocomplete="off" />
                                    </div>
                                    <div id="categoryOptionList" class="max-h-60 overflow-auto py-1">
                                        @foreach (var category in Model.Categories)
                                        {
                                            <div class="product-select-option category-option px-3 py-2.5 text-sm text-gray-900 cursor-pointer hover:bg-gray-100" data-value="@category.Id" data-text="@Html.Raw(category.Name)">@Html.Raw(category.Name)</div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <span asp-validation-for="Product.CategoryId" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                        <div>
                            <label asp-for="Product.SubCategoryId" class="block text-sm font-medium text-gray-700 mb-2">Alt Kategori <span class="text-red-500">*</span></label>
                            <input type="hidden" asp-for="Product.SubCategoryId" id="subCategoryHidden" />
                            <div class="relative product-select-wrapper" data-select="subcategory">
                                <button type="button" id="subCategorySelectBtn" class="product-select-btn w-full h-12 px-4 pr-10 text-left rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-900 shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-800 focus:border-transparent flex items-center" aria-haspopup="listbox" aria-expanded="false">
                                    <span class="block truncate" id="subCategorySelectText">@Html.Raw(selectedSubCategoryName)</span>
                                    <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                        <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.55.24l3.25 3.5a.75.75 0 11-1.1 1.02L10 4.852 7.3 7.76a.75.75 0 01-1.1-1.02l3.25-3.5A.75.75 0 0110 3zm-3.76 9.2a.75.75 0 011.06.04l2.7 2.908 2.7-2.908a.75.75 0 111.1 1.02l-3.25 3.5a.75.75 0 01-1.1 0l-3.25-3.5a.75.75 0 01.04-1.06z" clip-rule="evenodd" /></svg>
                                    </span>
                                </button>
                                <div id="subCategoryDropdownPanel" class="hidden absolute z-50 mt-1 w-full rounded-lg bg-white py-1 shadow-xl ring-1 ring-black ring-opacity-5 border border-gray-200">
                                    <div class="px-2 py-1.5 border-b border-gray-100">
                                        <input type="text" id="subCategorySearch" placeholder="Alt kategori ara..." class="w-full px-3 py-2 text-sm border border-gray-200 rounded-md focus:ring-2 focus:ring-gray-800 focus:border-transparent" autocomplete="off" />
                                    </div>
                                    <div id="subCategoryOptionList" class="max-h-60 overflow-auto py-1">
                                        @foreach (var subCategory in Model.SubCategories)
                                        {
                                            <div class="product-select-option subcategory-option px-3 py-2.5 text-sm text-gray-900 cursor-pointer hover:bg-gray-100" data-value="@subCategory.Id" data-text="@Html.Raw(subCategory.Name)">@Html.Raw(subCategory.Name)</div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <span asp-validation-for="Product.SubCategoryId" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                    </div>
                    <div>
                        <label asp-for="Product.Name" class="block text-sm font-medium text-gray-700 mb-2">Ürün Adı <span class="text-red-500">*</span> <span class="text-gray-500 font-normal">(max @Product.NameMaxLength karakter)</span></label>
                        <input type="text" asp-for="Product.Name" maxlength="@Product.NameMaxLength" class="@inputClass" placeholder="Örn: Şişme Oyun Parkı 5x5">
                        <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.NameMaxLength">@((Model.Product?.Name ?? "").Length) / @Product.NameMaxLength</span>
                        <span asp-validation-for="Product.Name" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>

            <!-- Fiyat ve Stok -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Fiyat ve Stok</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label asp-for="Product.Price" class="block text-sm font-medium text-gray-700 mb-2">Fiyat (₺) <span class="text-red-500">*</span></label>
                        <input type="number" asp-for="Product.Price" step="0.01" min="0" class="@inputClass input-select-all" placeholder="0.00">
                        <span asp-validation-for="Product.Price" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    <div>
                        <label asp-for="Product.Stock" class="block text-sm font-medium text-gray-700 mb-2">Stok <span class="text-red-500">*</span></label>
                        <input type="number" asp-for="Product.Stock" min="0" class="@inputClass input-select-all" placeholder="0">
                        <span asp-validation-for="Product.Stock" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>

            <!-- İçerik ve Açıklamalar -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">İçerik ve Açıklamalar</h2>
                <div class="space-y-4">
                    <div>
                        <label asp-for="Product.Description" class="block text-sm font-medium text-gray-700 mb-2">Açıklama <span class="text-red-500">*</span></label>
                        <textarea asp-for="Product.Description" rows="5" class="@inputClass" placeholder="Ürün hakkında detaylı açıklama..."></textarea>
                        <span asp-validation-for="Product.Description" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                    <div>
                        <label asp-for="Product.Summary" class="block text-sm font-medium text-gray-700 mb-2">Özet <span class="text-gray-500 font-normal">(max @Product.SummaryMaxLength karakter)</span></label>
                        <textarea asp-for="Product.Summary" maxlength="@Product.SummaryMaxLength" rows="3" class="@inputClass" placeholder="Kısa özet (isteğe bağlı)"></textarea>
                        <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.SummaryMaxLength">@((Model.Product?.Summary ?? "").Length) / @Product.SummaryMaxLength</span>
                        <small class="text-gray-500 text-sm mt-1 block">Kart ve detay sayfasında görünür.</small>
                    </div>
                    <div>
                        <label asp-for="Product.TechnicalDescription" class="block text-sm font-medium text-gray-700 mb-2">Teknik Açıklama (HTML)</label>
                        <textarea asp-for="Product.TechnicalDescription" id="technicalDescription" rows="8" class="@inputClass" placeholder="Teknik özellikler, HTML kullanılabilir..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Ürün Teknik Bilgileri -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Ürün Teknik Bilgileri</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Şişmiş ürün</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label asp-for="Product.InflatedLength" class="block text-sm font-medium text-gray-700 mb-2">Uzunluk (m)</label>
                                <input type="text" asp-for="Product.InflatedLength" inputmode="decimal" class="@inputClass" placeholder="Örn: 12 veya 3,5">
                            </div>
                            <div>
                                <label asp-for="Product.InflatedWidth" class="block text-sm font-medium text-gray-700 mb-2">Genişlik (m)</label>
                                <input type="text" asp-for="Product.InflatedWidth" inputmode="decimal" class="@inputClass" placeholder="Örn: 3 veya 3,5">
                            </div>
                            <div>
                                <label asp-for="Product.InflatedHeight" class="block text-sm font-medium text-gray-700 mb-2">Yükseklik (m)</label>
                                <input type="text" asp-for="Product.InflatedHeight" inputmode="decimal" class="@inputClass" placeholder="Örn: 3 veya 3,5">
                            </div>
                            <div>
                                <label asp-for="Product.UserCount" class="block text-sm font-medium text-gray-700 mb-2">Kullanıcı Sayısı</label>
                                <input type="number" asp-for="Product.UserCount" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Montaj / demontaj</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label asp-for="Product.AssemblyTime" class="block text-sm font-medium text-gray-700 mb-2">Montaj ve demontaj süresi (saat)</label>
                                <input type="number" asp-for="Product.AssemblyTime" step="0.01" min="0" data-decimal="true" class="@inputClass" placeholder="Örn: 2 veya 1,5">
                            </div>
                            <div>
                                <label asp-for="Product.RequiredPersonCount" class="block text-sm font-medium text-gray-700 mb-2">Gerekli kişi sayısı</label>
                                <input type="number" asp-for="Product.RequiredPersonCount" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                            <div>
                                <label asp-for="Product.FanDescription" class="block text-sm font-medium text-gray-700 mb-2">Fan <span class="text-gray-500 font-normal">(max @Product.FanDescriptionMaxLength)</span></label>
                                <input type="text" asp-for="Product.FanDescription" maxlength="@Product.FanDescriptionMaxLength" class="@inputClass" placeholder="Örn: 1 x türbin">
                                <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.FanDescriptionMaxLength">@((Model.Product?.FanDescription ?? "").Length) / @Product.FanDescriptionMaxLength</span>
                            </div>
                            <div>
                                <label asp-for="Product.FanWeightKg" class="block text-sm font-medium text-gray-700 mb-2">Fan ağırlığı (kg)</label>
                                <input type="number" asp-for="Product.FanWeightKg" step="0.01" min="0" data-decimal="true" class="@inputClass" placeholder="Örn: 20 veya 2,5">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Paketlenmiş ürünün özellikleri</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label asp-for="Product.PackagedLength" class="block text-sm font-medium text-gray-700 mb-2">Uzunluk (cm)</label>
                                <input type="text" asp-for="Product.PackagedLength" inputmode="decimal" class="@inputClass" placeholder="Örn: 80 veya 45,5">
                            </div>
                            <div>
                                <label asp-for="Product.PackagedDepth" class="block text-sm font-medium text-gray-700 mb-2">Derinlik (cm)</label>
                                <input type="text" asp-for="Product.PackagedDepth" inputmode="decimal" class="@inputClass" placeholder="Örn: 70 veya 35,5">
                            </div>
                            <div>
                                <label asp-for="Product.PackagedWeightKg" class="block text-sm font-medium text-gray-700 mb-2">Ağırlık (kg)</label>
                                <input type="number" asp-for="Product.PackagedWeightKg" step="0.01" min="0" data-decimal="true" class="@inputClass" placeholder="Örn: 95 veya 12,5">
                            </div>
                            <div>
                                <label asp-for="Product.PackagePalletCount" class="block text-sm font-medium text-gray-700 mb-2">Paket / palet sayısı</label>
                                <input type="number" asp-for="Product.PackagePalletCount" step="1" min="0" class="@inputClass" placeholder="Örn: 2">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Sertifika ve Garanti</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label asp-for="Product.WarrantyDescription" class="block text-sm font-medium text-gray-700 mb-2">Garanti Süresi <span class="text-gray-500 font-normal">(max @Product.WarrantyDescriptionMaxLength)</span></label>
                                <input type="text" asp-for="Product.WarrantyDescription" maxlength="@Product.WarrantyDescriptionMaxLength" class="@inputClass" placeholder="Örn: 2 yıl garanti">
                                <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.WarrantyDescriptionMaxLength">@((Model.Product?.WarrantyDescription ?? "").Length) / @Product.WarrantyDescriptionMaxLength</span>
                            </div>
                            <div>
                                <label asp-for="Product.AfterSalesService" class="block text-sm font-medium text-gray-700 mb-2">Garanti Sonrası Hizmet <span class="text-gray-500 font-normal">(max @Product.AfterSalesServiceMaxLength)</span></label>
                                <input type="text" asp-for="Product.AfterSalesService" maxlength="@Product.AfterSalesServiceMaxLength" class="@inputClass" placeholder="Örn: 5 yıllık servis ve bakım desteği">
                                <span class="char-counter text-sm text-gray-500 mt-1 block" data-max="@Product.AfterSalesServiceMaxLength">@((Model.Product?.AfterSalesService ?? "").Length) / @Product.AfterSalesServiceMaxLength</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ürün Etiketleri ve Detay Özellikleri -->
            <div class="pb-8 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Ürün Etiketleri ve Detay Özellikleri</h2>
                <p class="text-sm text-gray-500 mb-4">Bu alanlar ürün detay sayfasında etiket ve özellik etiketleri olarak gösterilir.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Teslimat süresi (iş günü)</label>
                        <div class="flex items-center gap-2 flex-wrap">
                            <input type="number" asp-for="Product.DeliveryDaysMin" step="1" min="0" class="w-24 px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent" placeholder="Min">
                            <span class="text-gray-500">–</span>
                            <input type="number" asp-for="Product.DeliveryDaysMax" step="1" min="0" class="w-24 px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent" placeholder="Max">
                            <span class="text-sm text-gray-500">iş günü</span>
                        </div>
                    </div>
                    <div>
                        <label asp-for="Product.MaterialWeightGrm2" class="block text-sm font-medium text-gray-700 mb-2">Kumaş ağırlığı (gr/m²)</label>
                        <input type="number" asp-for="Product.MaterialWeightGrm2" step="0.01" min="0" data-decimal="true" class="@inputClass" placeholder="Örn: 650 veya 420,5">
                    </div>
                    <div>
                        <label asp-for="Product.InflatedWeightKg" class="block text-sm font-medium text-gray-700 mb-2">Şişmiş ürün ağırlığı (kg)</label>
                        <input type="number" asp-for="Product.InflatedWeightKg" step="0.01" min="0" data-decimal="true" class="@inputClass" placeholder="Örn: 95 veya 12,5">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Renk seçenekleri</label>
                        <input type="hidden" asp-for="Product.ColorOptions" id="Product_ColorOptions" value="@Model.Product?.ColorOptions">
                        <div id="color-checkbox-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-3">
                            <!-- Tile checkbox'lar JavaScript ile doldurulacak -->
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Ürünün mevcut olduğu renkleri işaretleyin.</p>
                    </div>
                </div>
            </div>

            <!-- Seçenekler (checkbox tile) -->
            <div class="pb-2">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Seçenekler</h2>
                <p class="text-sm text-gray-500 mb-4">Ürün özelliklerini seçmek için ilgili kutucuğa tıklayın.</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                    <label class="option-tile group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[100px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 focus-within:border-gray-800 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-800 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">
                        <input type="checkbox" asp-for="Product.IsActive" class="option-checkbox peer sr-only">
                        <span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100" aria-hidden="true">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </span>
                        <span class="mb-2 flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-green-100 text-green-700" aria-hidden="true">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        </span>
                        <span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">Ürün aktif</span>
                        <span class="text-center text-[10px] text-gray-500 mt-0.5 select-none">Sitede listelenir</span>
                    </label>
                    <label class="option-tile group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[100px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 focus-within:border-gray-800 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-800 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">
                        <input type="checkbox" asp-for="Product.HasCertificate" class="option-checkbox peer sr-only">
                        <span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100" aria-hidden="true">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </span>
                        <span class="mb-2 flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-amber-100 text-amber-700" aria-hidden="true">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                        </span>
                        <span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">Sertifikalı ürün</span>
                    </label>
                    <label class="option-tile group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[100px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 focus-within:border-gray-800 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-800 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">
                        <input type="checkbox" asp-for="Product.IsDiscounted" class="option-checkbox peer sr-only">
                        <span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100" aria-hidden="true">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </span>
                        <span class="mb-2 flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-red-100 text-red-600" aria-hidden="true">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                        </span>
                        <span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">İndirimli Ürün</span>
                    </label>
                    <label class="option-tile group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[100px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 focus-within:border-gray-800 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-800 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">
                        <input type="checkbox" asp-for="Product.IsPopular" class="option-checkbox peer sr-only">
                        <span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100" aria-hidden="true">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </span>
                        <span class="mb-2 flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-yellow-100 text-yellow-700" aria-hidden="true">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        </span>
                        <span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">Popüler</span>
                    </label>
                    <label class="option-tile group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[100px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 focus-within:border-gray-800 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-800 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">
                        <input type="checkbox" asp-for="Product.IsProjectSpecial" class="option-checkbox peer sr-only">
                        <span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100" aria-hidden="true">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </span>
                        <span class="mb-2 flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-indigo-100 text-indigo-700" aria-hidden="true">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        </span>
                        <span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">Projeye özel</span>
                    </label>
                    <label class="option-tile group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[100px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-800 focus-within:ring-offset-2 focus-within:border-gray-800 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-800 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">
                        <input type="checkbox" asp-for="Product.IsFireResistant" class="option-checkbox peer sr-only">
                        <span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100" aria-hidden="true">
                            <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </span>
                        <span class="mb-2 flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-orange-100 text-orange-600" aria-hidden="true">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/></svg>
                        </span>
                        <span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">Ateşe dayanıklı</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="border-t border-gray-200 mt-8 pt-6">
            <div class="flex items-center gap-3">
                <button type="submit" id="productSubmitBtn" class="inline-flex items-center justify-center px-6 py-3 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-colors duration-200 shadow-md text-base disabled:opacity-70 disabled:cursor-not-allowed" data-loading-text="Ürün güncelleniyor...">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Güncelle
                </button>
                <a href="/admin/products" class="inline-flex items-center px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition-colors duration-200 text-base">İptal</a>
            </div>
        </div>
    </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
    <script>
        // Teknik bilgi küsüratlı alanlar: virgülü noktaya çevir (model binding için)
        (function() {
            var form = document.getElementById('productSubmitBtn') && document.getElementById('productSubmitBtn').closest('form');
            if (form) form.addEventListener('submit', function() {
                form.querySelectorAll('input[data-decimal="true"]').forEach(function(inp) {
                    if (inp.value && typeof inp.value === 'string' && inp.value.indexOf(',') !== -1)
                        inp.value = inp.value.replace(',', '.');
                });
            });
        })();

        // Fiyat ve Stok: focus/click ile tüm değeri seç
        document.querySelectorAll('.input-select-all').forEach(function(el) {
            el.addEventListener('focus', function() { this.select(); });
            el.addEventListener('click', function() { this.select(); });
        });

        let editor;
        ClassicEditor.create(document.querySelector('#technicalDescription'), {
            toolbar: { items: ['heading', '|', 'bold', 'italic', 'underline', 'strikethrough', '|', 'bulletedList', 'numberedList', '|', 'outdent', 'indent', '|', 'link', 'blockQuote', 'insertTable', '|', 'undo', 'redo'] },
            language: 'tr',
            placeholder: 'Ürünün teknik özellikleri ve detaylı açıklaması...',
            table: { contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells'] }
        }).then(function(editorInstance) { editor = editorInstance; }).catch(function(err) { console.error('CKEditor hatası:', err); });

        (function() {
            var categoryBtn = document.getElementById('categorySelectBtn');
            var categoryPanel = document.getElementById('categoryDropdownPanel');
            var categorySearch = document.getElementById('categorySearch');
            var categoryOptionList = document.getElementById('categoryOptionList');
            var categoryHidden = document.getElementById('categoryHidden');
            var categorySelectText = document.getElementById('categorySelectText');
            var subCategoryBtn = document.getElementById('subCategorySelectBtn');
            var subCategoryPanel = document.getElementById('subCategoryDropdownPanel');
            var subCategorySearch = document.getElementById('subCategorySearch');
            var subCategoryOptionList = document.getElementById('subCategoryOptionList');
            var subCategoryHidden = document.getElementById('subCategoryHidden');
            var subCategorySelectText = document.getElementById('subCategorySelectText');

            function filterOptions(listEl, searchInput, optionClass) {
                var q = (searchInput.value || '').toLowerCase().trim();
                var options = listEl.querySelectorAll(optionClass || '.product-select-option');
                options.forEach(function(opt) {
                    var text = (opt.getAttribute('data-text') || opt.textContent || '').toLowerCase();
                    opt.style.display = q === '' || text.indexOf(q) !== -1 ? '' : 'none';
                });
            }

            function closeAll() {
                if (categoryPanel) categoryPanel.classList.add('hidden');
                if (subCategoryPanel) subCategoryPanel.classList.add('hidden');
                document.removeEventListener('click', closeAll);
            }

            if (categoryBtn && categoryPanel) {
                categoryBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    subCategoryPanel.classList.add('hidden');
                    categoryPanel.classList.toggle('hidden');
                    if (!categoryPanel.classList.contains('hidden')) {
                        categorySearch.value = '';
                        filterOptions(categoryOptionList, { value: '' }, '.category-option');
                        categorySearch.focus();
                        setTimeout(function() { document.addEventListener('click', closeAll); }, 0);
                    } else document.removeEventListener('click', closeAll);
                });
            }
            if (categorySearch && categoryOptionList) {
                categorySearch.addEventListener('input', function() { filterOptions(categoryOptionList, categorySearch, '.category-option'); });
                categorySearch.addEventListener('keydown', function(e) { e.stopPropagation(); });
            }
            categoryOptionList && categoryOptionList.addEventListener('click', function(e) {
                var opt = e.target.closest('.category-option');
                if (!opt) return;
                var val = opt.getAttribute('data-value');
                var text = (opt.textContent || opt.getAttribute('data-text') || '').trim();
                categoryHidden.value = val;
                categorySelectText.textContent = text;
                categoryPanel.classList.add('hidden');
                document.removeEventListener('click', closeAll);
                subCategorySelectText.textContent = 'Yükleniyor...';
                subCategoryHidden.value = '0';
                if (val && val !== '0') {
                    $.get('/admin/products/edit?handler=SubCategories&categoryId=' + val, function(data) {
                        subCategoryOptionList.innerHTML = (data || []).map(function(item) {
                            var name = (item.name || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            return '<div class="product-select-option subcategory-option px-3 py-2.5 text-sm text-gray-900 cursor-pointer hover:bg-gray-100" data-value="' + item.id + '" data-text="' + name + '">' + (item.name || '') + '</div>';
                        }).join('');
                        subCategorySelectText.textContent = 'Alt kategori seçin...';
                    }).fail(function() {
                        subCategoryOptionList.innerHTML = '';
                        subCategorySelectText.textContent = 'Hata! Tekrar deneyin';
                    });
                } else {
                    subCategoryOptionList.innerHTML = '';
                    subCategorySelectText.textContent = 'Önce kategori seçin...';
                }
            });

            if (subCategoryBtn && subCategoryPanel) {
                subCategoryBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    categoryPanel.classList.add('hidden');
                    subCategoryPanel.classList.toggle('hidden');
                    if (!subCategoryPanel.classList.contains('hidden')) {
                        subCategorySearch.value = '';
                        filterOptions(subCategoryOptionList, { value: '' }, '.subcategory-option');
                        subCategorySearch.focus();
                        setTimeout(function() { document.addEventListener('click', closeAll); }, 0);
                    } else document.removeEventListener('click', closeAll);
                });
            }
            if (subCategorySearch && subCategoryOptionList) {
                subCategorySearch.addEventListener('input', function() { filterOptions(subCategoryOptionList, subCategorySearch, '.subcategory-option'); });
                subCategorySearch.addEventListener('keydown', function(e) { e.stopPropagation(); });
            }
            subCategoryOptionList && subCategoryOptionList.addEventListener('click', function(e) {
                var opt = e.target.closest('.subcategory-option');
                if (!opt) return;
                var val = opt.getAttribute('data-value');
                var text = (opt.textContent || opt.getAttribute('data-text') || '').trim();
                subCategoryHidden.value = val;
                subCategorySelectText.textContent = text;
                subCategoryPanel.classList.add('hidden');
                document.removeEventListener('click', closeAll);
            });
        })();

        $('#productEditForm').on('submit', function() {
            if (editor) editor.updateSourceElement();
            var $btn = $('#productSubmitBtn');
            if ($btn.length && $btn.data('loading-text')) {
                showLoading($btn.data('loading-text'));
                $btn.prop('disabled', true).html('<span class="inline-block w-5 h-5 mr-2 border-2 border-white border-t-transparent rounded-full animate-spin"></span>' + $btn.data('loading-text'));
            }
        });

        $('.delete-image-btn').on('click', function() {
            var $btn = $(this);
            var $form = $btn.closest('.delete-image-form');
            showDeleteConfirm('Bu resim ürün sayfasından kaldırılacak. Bu işlem geri alınamaz.', function() {
                showLoading('Resim siliniyor...');
                $form.submit();
            });
        });

        setTimeout(function() { $('.bg-green-50, .bg-red-50').fadeOut(); }, 5000);

        // ----- Yeni resim önizleme (ürün güncelleme) -----
        (function() {
            var MAX_FILE_SIZE_MB = 10;
            var MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
            var dropZone = document.getElementById('editImageDropZone');
            var fileInput = document.getElementById('editNewImagesInput');
            var previewContainer = document.getElementById('editImagePreviewContainer');
            var previewGrid = document.getElementById('editImagePreviewGrid');
            var previewCountEl = document.getElementById('editImagePreviewCount');
            var clearBtn = document.getElementById('editImageClearBtn');
            if (!dropZone || !fileInput) return;

            function renderPreviews(files) {
                previewGrid.innerHTML = '';
                if (!files || files.length === 0) {
                    previewContainer.classList.add('hidden');
                    return;
                }
                previewContainer.classList.remove('hidden');
                previewCountEl.textContent = files.length;
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var card = document.createElement('div');
                    card.className = 'relative rounded-lg border-2 border-gray-200 overflow-hidden bg-gray-50 group';
                    var img = document.createElement('img');
                    img.className = 'w-full aspect-square object-cover';
                    img.alt = file.name || '';
                    var reader = new FileReader();
                    reader.onload = (function(el) { return function(e) { el.src = e.target.result; }; })(img);
                    reader.readAsDataURL(file);
                    var overlay = document.createElement('div');
                    overlay.className = 'absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-2';
                    var label = document.createElement('span');
                    label.className = 'text-white text-xs font-medium block truncate';
                    label.textContent = file.name || 'isimsiz';
                    var badge = document.createElement('span');
                    badge.className = 'text-[10px] text-gray-200 mt-0.5 block';
                    badge.textContent = 'Resim ' + (i + 1);
                    overlay.appendChild(label);
                    overlay.appendChild(badge);
                    card.appendChild(img);
                    card.appendChild(overlay);
                    previewGrid.appendChild(card);
                }
            }

            function handleFiles(fileList) {
                if (!fileList || fileList.length === 0) { renderPreviews([]); return; }
                var files = Array.prototype.slice.call(fileList);
                var valid = [];
                var tooBig = [];
                for (var i = 0; i < files.length; i++) {
                    if (!files[i].type.match(/^image\/(jpeg|png|webp|gif)$/i)) continue;
                    if (files[i].size > MAX_FILE_SIZE_BYTES) { tooBig.push(files[i].name); continue; }
                    valid.push(files[i]);
                }
                if (tooBig.length && typeof showSnackbar === 'function') showSnackbar('Bazı dosyalar ' + MAX_FILE_SIZE_MB + ' MB\'dan büyük olduğu için atlandı: ' + tooBig.join(', '), 'warning');
                if (valid.length === 0) { fileInput.value = ''; renderPreviews([]); return; }
                var dt = new DataTransfer();
                valid.forEach(function(f) { dt.items.add(f); });
                fileInput.files = dt.files;
                renderPreviews(fileInput.files);
            }

            fileInput.addEventListener('change', function() { handleFiles(this.files); });
            if (clearBtn) clearBtn.addEventListener('click', function() { fileInput.value = ''; renderPreviews([]); });
            dropZone.addEventListener('dragover', function(e) { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('border-gray-500', 'bg-gray-100'); });
            dropZone.addEventListener('dragleave', function(e) { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('border-gray-500', 'bg-gray-100'); });
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-gray-500', 'bg-gray-100');
                var files = e.dataTransfer && e.dataTransfer.files;
                if (files && files.length) handleFiles(files);
            });
        })();

        $(function() {
            var $colorHidden = $('input[name="Product.ColorOptions"]');
            var $colorGrid = $('#color-checkbox-grid');
            if (!$colorHidden.length || !$colorGrid.length) return;
            var colorList = [
                { name: 'Kırmızı', hex: '#dc2626' },
                { name: 'Mavi', hex: '#2563eb' },
                { name: 'Yeşil', hex: '#16a34a' },
                { name: 'Sarı', hex: '#eab308' },
                { name: 'Turuncu', hex: '#ea580c' },
                { name: 'Mor', hex: '#9333ea' },
                { name: 'Pembe', hex: '#db2777' },
                { name: 'Beyaz', hex: '#ffffff' },
                { name: 'Siyah', hex: '#171717' },
                { name: 'Gri', hex: '#6b7280' },
                { name: 'Lacivert', hex: '#1e3a5f' },
                { name: 'Turkuaz', hex: '#0d9488' },
                { name: 'Açık Mavi', hex: '#0ea5e9' },
                { name: 'Amber', hex: '#f59e0b' },
                { name: 'Kahverengi', hex: '#92400e' },
                { name: 'Bordo', hex: '#991b1b' }
            ];
            function getSelectedEntries() {
                var raw = $colorHidden.val() || '';
                if (!raw.trim()) return [];
                return raw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
            }
            function syncFromHidden() {
                var selected = getSelectedEntries();
                $colorGrid.find('input[type="checkbox"]').each(function() {
                    var $cb = $(this);
                    var name = $cb.data('name');
                    var hex = $cb.data('hex');
                    var entry = name + ' (#' + hex.replace('#', '') + ')';
                    var checked = selected.some(function(e) {
                        return e.toLowerCase() === entry.toLowerCase() || (e === hex) || (e === hex.replace('#', ''));
                    });
                    $cb.prop('checked', !!checked);
                });
            }
            function updateHidden() {
                var checked = [];
                $colorGrid.find('input[type="checkbox"]:checked').each(function() {
                    var name = $(this).data('name');
                    var hex = $(this).data('hex');
                    checked.push(name + ' (#' + hex.replace('#', '') + ')');
                });
                $colorHidden.val(checked.join(', '));
            }
            colorList.forEach(function(c) {
                var swatchBorder = (c.hex.toLowerCase() === '#ffffff') ? ' border-2 border-gray-300' : '';
                var checkSvg = '<svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
                var $label = $('<label class="group relative flex flex-col items-center justify-center cursor-pointer rounded-xl border-2 border-gray-200 bg-white p-4 min-h-[96px] transition-all duration-200 ease-out hover:border-gray-300 hover:bg-gray-50 hover:shadow-sm focus-within:ring-2 focus-within:ring-gray-900 focus-within:ring-offset-2 focus-within:border-gray-900 has-[:checked]:border-gray-900 has-[:checked]:bg-gray-100 has-[:checked]:ring-2 has-[:checked]:ring-gray-900 has-[:checked]:ring-offset-2 has-[:checked]:shadow-md">');
                var $input = $('<input type="checkbox">').attr({ 'data-name': c.name, 'data-hex': c.hex }).addClass('color-cb peer sr-only');
                var $checkBadge = $('<span class="absolute right-2 top-2 flex h-6 w-6 items-center justify-center rounded-full bg-gray-900 text-white opacity-0 transition-opacity duration-200 peer-checked:opacity-100">').html(checkSvg);
                var $swatch = $('<span class="mb-2 flex h-11 w-11 shrink-0 items-center justify-center rounded-full shadow-inner' + swatchBorder + '" style="background-color:' + c.hex + '" aria-hidden="true">');
                var $name = $('<span class="text-center text-xs font-medium text-gray-700 select-none leading-tight">').text(c.name);
                $label.append($input).append($checkBadge).append($swatch).append($name);
                $colorGrid.append($label);
            });
            $colorGrid.on('change', '.color-cb', updateHidden);
            syncFromHidden();
        });
    </script>
}
