@page
@model BalonPark.Pages.Admin.Mails.ComposeModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = Model.OriginalMessage != null ? "E-postaya Yanıtla" : "Yeni E-posta";
    ViewData["AdminUserName"] = Model.AdminUserName;
    ViewData["AdminEmail"] = Model.AdminEmail;
}

<!-- Header -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    @if (Model.OriginalMessage != null)
                    {
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    }
                    else
                    {
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    }
                </svg>
                @(Model.OriginalMessage != null ? "E-postaya Yanıtla" : "Yeni E-posta Oluştur")
            </h1>
            <p class="text-gray-600 mt-2">
                @(Model.OriginalMessage != null 
                    ? $"{Model.OriginalMessage.From} adresine yanıt gönderin" 
                    : "Alıcıya e-posta gönderin")
            </p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="/admin/mails" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Geri Dön
            </a>
        </div>
    </div>
</div>

<!-- Messages -->
@if (!string.IsNullOrEmpty(TempData["ErrorMessage"]?.ToString()))
{
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded-r-lg">
        <div class="flex items-center">
            <svg class="w-6 h-6 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <p class="font-semibold text-red-800">Hata!</p>
                <p class="text-red-700">@TempData["ErrorMessage"]</p>
            </div>
        </div>
    </div>
}

<!-- Reply Context -->
@if (Model.OriginalMessage != null)
{
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-r-lg">
        <div class="flex items-start">
            <svg class="w-6 h-6 text-blue-400 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="flex-1">
                <p class="font-semibold text-blue-800 mb-2">Yanıtlanıyor:</p>
                <div class="space-y-1 text-sm">
                    <p class="text-blue-700"><strong>Konu:</strong> @Model.OriginalMessage.Subject</p>
                    <p class="text-blue-600"><strong>Gönderen:</strong> @Model.OriginalMessage.FromName (@Model.OriginalMessage.From)</p>
                    <p class="text-blue-600"><strong>Tarih:</strong> @Model.OriginalMessage.Date.ToString("dd.MM.yyyy HH:mm")</p>
                </div>
            </div>
        </div>
    </div>
}

<!-- Compose Form -->
<div class="bg-white rounded-lg shadow-md p-6">
    <form id="composeForm" method="post">
        <div class="space-y-6">
            <!-- Recipient Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label asp-for="EmailModel.To" class="block text-sm font-medium text-gray-700 mb-2">
                        Alıcı E-posta <span class="text-red-500">*</span>
                    </label>
                    <input asp-for="EmailModel.To" type="email" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all duration-200" 
                           placeholder="ornek@email.com" required>
                    <span asp-validation-for="EmailModel.To" class="text-red-500 text-sm mt-1 block"></span>
                </div>

                <div>
                    <label asp-for="EmailModel.ToName" class="block text-sm font-medium text-gray-700 mb-2">
                        Alıcı Adı
                    </label>
                    <input asp-for="EmailModel.ToName" type="text" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all duration-200" 
                           placeholder="Alıcının adı (opsiyonel)">
                </div>
            </div>

            <!-- Subject -->
            <div>
                <label asp-for="EmailModel.Subject" class="block text-sm font-medium text-gray-700 mb-2">
                    Konu <span class="text-red-500">*</span>
                </label>
                <input asp-for="EmailModel.Subject" type="text" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all duration-200" 
                       placeholder="E-posta konusu" required>
                <span asp-validation-for="EmailModel.Subject" class="text-red-500 text-sm mt-1 block"></span>
            </div>

            <!-- Format Toggle -->
            <div class="flex items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                <input asp-for="EmailModel.IsHtml" type="checkbox" id="htmlFormatToggle"
                       class="h-4 w-4 text-gray-900 focus:ring-gray-900 border-gray-300 rounded">
                <label asp-for="EmailModel.IsHtml" class="ml-3 block text-sm font-medium text-gray-700">
                    HTML formatında gönder
                </label>
                <span class="ml-auto text-xs text-gray-500">Gelişmiş editör ile yazın</span>
            </div>

            <!-- Message Body -->
            <div>
                <label asp-for="EmailModel.Body" class="block text-sm font-medium text-gray-700 mb-2">
                    Mesaj İçeriği <span class="text-red-500">*</span>
                </label>
                
                <!-- CKEditor için -->
                <div id="ckeditorContainer" style="display: none;">
                    <textarea id="ckeditor" name="EmailModel.Body" rows="14"></textarea>
                </div>
                
                <!-- Normal textarea için -->
                <div id="textareaContainer">
                    <textarea id="plainTextarea" name="EmailModel.Body" rows="14" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all duration-200 font-mono text-sm" 
                              placeholder="E-posta içeriğinizi buraya yazın..." required></textarea>
                </div>
                
                <span asp-validation-for="EmailModel.Body" class="text-red-500 text-sm mt-1 block"></span>
                <p class="mt-2 text-sm text-gray-500 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="editorHint">Düz metin formatında yazın.</span>
                </p>
            </div>

            @if (Model.OriginalMessage != null)
            {
                <input asp-for="EmailModel.InReplyTo" type="hidden" />
                <input asp-for="EmailModel.References" type="hidden" />
            }
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-6 mt-6 border-t border-gray-200">
            <a href="/admin/mails" class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                İptal
            </a>
            <button type="submit" class="inline-flex items-center px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg transition-colors duration-200 shadow-md" data-loading-text="Gönderiliyor...">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                E-posta Gönder
            </button>
        </div>
    </form>
</div>

<!-- Original Message (if reply) -->
@if (Model.OriginalMessage != null)
{
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                <svg class="w-6 h-6 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                </svg>
                Orijinal Mesaj
            </h3>
        </div>
        <div class="px-6 py-4 bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
                <div>
                    <dt class="font-medium text-gray-500">Tarih</dt>
                    <dd class="mt-1 text-gray-900">@Model.OriginalMessage.Date.ToString("dd MMMM yyyy, HH:mm")</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Gönderen</dt>
                    <dd class="mt-1 text-gray-900">@Model.OriginalMessage.FromName</dd>
                    <dd class="text-xs text-gray-500">@Model.OriginalMessage.From</dd>
                </div>
                <div>
                    <dt class="font-medium text-gray-500">Konu</dt>
                    <dd class="mt-1 text-gray-900">@Model.OriginalMessage.Subject</dd>
                </div>
            </div>
        </div>
        <div class="px-6 py-6 border-t border-gray-300 bg-white">
            @if (Model.OriginalMessage.IsHtml)
            {
                <div class="email-html-content">
                    @Html.Raw(Model.OriginalMessage.Body)
                </div>
            }
            else
            {
                <div class="email-text-content">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">@Model.OriginalMessage.Body</p>
                </div>
            }
        </div>
    </div>
}

@section Styles {
<style>
/* Email HTML Content Styles */
.email-html-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: #374151;
    max-width: none;
    word-wrap: break-word;
    overflow-wrap: break-word;
    /* Container isolation */
    isolation: isolate;
    contain: layout style;
    overflow-x: hidden;
}

/* Force all elements to respect container bounds */
.email-html-content *,
.email-html-content *:before,
.email-html-content *:after {
    max-width: 100% !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
}

/* Reset problematic styles from email HTML */
.email-html-content table {
    max-width: 100% !important;
    width: 100% !important;
    table-layout: fixed !important;
}

.email-html-content td,
.email-html-content th {
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    max-width: none !important;
}

/* Override email inline styles that break layout */
.email-html-content [style*="width"] {
    max-width: 100% !important;
    width: auto !important;
}

.email-html-content [style*="min-width"] {
    min-width: auto !important;
}

.email-html-content [style*="max-width"] {
    max-width: 100% !important;
}

/* Handle email tables specifically */
.email-html-content table[width],
.email-html-content td[width],
.email-html-content th[width] {
    max-width: 100% !important;
    width: 100% !important;
}

/* Prevent email images from breaking layout */
.email-html-content img {
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
}

.email-html-content h1,
.email-html-content h2,
.email-html-content h3,
.email-html-content h4,
.email-html-content h5,
.email-html-content h6 {
    font-weight: 600;
    line-height: 1.25;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: #111827;
}

.email-html-content h1 { font-size: 1.875rem; }
.email-html-content h2 { font-size: 1.5rem; }
.email-html-content h3 { font-size: 1.25rem; }
.email-html-content h4 { font-size: 1.125rem; }
.email-html-content h5 { font-size: 1rem; }
.email-html-content h6 { font-size: 0.875rem; }

.email-html-content p {
    margin-top: 1em;
    margin-bottom: 1em;
    line-height: 1.7;
}

.email-html-content a {
    color: #2563eb;
    text-decoration: underline;
    font-weight: 500;
}

.email-html-content a:hover {
    color: #1d4ed8;
}

.email-html-content ul,
.email-html-content ol {
    margin-top: 1em;
    margin-bottom: 1em;
    padding-left: 2em;
}

.email-html-content li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

.email-html-content blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #e5e7eb;
    font-style: italic;
    color: #6b7280;
}

.email-html-content code {
    background-color: #f3f4f6;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875em;
    color: #374151;
}

.email-html-content pre {
    background-color: #f3f4f6;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1em 0;
}

.email-html-content pre code {
    background-color: transparent;
    padding: 0;
    font-size: 0.875rem;
}

.email-html-content table {
    border-collapse: collapse;
    margin: 1em 0;
    width: 100%;
}

.email-html-content th,
.email-html-content td {
    border: 1px solid #e5e7eb;
    padding: 0.5rem 0.75rem;
    text-align: left;
}

.email-html-content th {
    background-color: #f9fafb;
    font-weight: 600;
}

.email-html-content img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1em 0;
}

.email-html-content hr {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 2em 0;
}

/* Reset any potentially problematic styles */
.email-html-content div,
.email-html-content span,
.email-html-content p {
    max-width: none !important;
    width: auto !important;
}

/* Ensure text content doesn't break layout */
.email-text-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: #374151;
    word-wrap: break-word;
    overflow-wrap: break-word;
}
</style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- CKEditor 5 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
    
    <script>
        let editor;
        
        // Sayfa yüklendiğinde checkbox durumuna göre editor'ı başlat
        document.addEventListener('DOMContentLoaded', function() {
            const htmlCheckbox = document.getElementById('htmlFormatToggle');
            if (htmlCheckbox.checked) {
                initializeCKEditor();
            }
        });
        
        // CKEditor başlatma fonksiyonu
        function initializeCKEditor() {
            const ckeditorContainer = document.getElementById('ckeditorContainer');
            const textareaContainer = document.getElementById('textareaContainer');
            const hint = document.getElementById('editorHint');
            
            textareaContainer.style.display = 'none';
            ckeditorContainer.style.display = 'block';
            hint.textContent = 'HTML formatında yazın. Gelişmiş editör kullanabilirsiniz.';
            
            if (!editor) {
                ClassicEditor
                    .create(document.querySelector('#ckeditor'), {
                        toolbar: {
                            items: [
                                'heading', '|',
                                'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|',
                                'blockQuote', 'insertTable', '|',
                                'undo', 'redo'
                            ]
                        },
                        language: 'tr',
                        table: {
                            contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                        }
                    })
                    .then(newEditor => {
                        editor = newEditor;
                        const plainContent = document.getElementById('plainTextarea').value;
                        if (plainContent) {
                            editor.setData(plainContent.replace(/\n/g, '<br>'));
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        }
        
        // CKEditor toggle
        document.getElementById('htmlFormatToggle').addEventListener('change', function() {
            const isHtml = this.checked;
            const ckeditorContainer = document.getElementById('ckeditorContainer');
            const textareaContainer = document.getElementById('textareaContainer');
            const hint = document.getElementById('editorHint');
            
            if (isHtml) {
                initializeCKEditor();
            } else {
                // Düz metne geç - Textarea göster
                ckeditorContainer.style.display = 'none';
                textareaContainer.style.display = 'block';
                hint.textContent = 'Düz metin formatında yazın.';
                
                // CKEditor içeriğini textarea'ya aktar
                if (editor) {
                    const htmlContent = editor.getData();
                    document.getElementById('plainTextarea').value = htmlContent.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
                }
            }
        });
        
        // Form submit handling - Fetch API
        document.getElementById('composeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // CKEditor içeriğini al
            const isHtml = document.getElementById('htmlFormatToggle').checked;
            let body = '';
            
            if (isHtml && editor) {
                body = editor.getData();
            } else {
                body = document.getElementById('plainTextarea').value;
            }
            
            const to = document.getElementById('EmailModel_To').value;
            const toName = document.getElementById('EmailModel_ToName').value;
            const subject = document.getElementById('EmailModel_Subject').value;
            
            if (!to || !subject || !body) {
                showErrorAlert('Lütfen tüm zorunlu alanları doldurun');
                return false;
            }
            
            const emailData = {
                to: to,
                toName: toName || '',
                subject: subject,
                body: body,
                isHtml: isHtml,
                inReplyTo: document.getElementById('EmailModel_InReplyTo')?.value || null,
                references: document.getElementById('EmailModel_References')?.value || null
            };
            
            try {
                showLoading('E-posta gönderiliyor...');
                
                const response = await fetch('/api/mails/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showSuccessAlert(result.message || 'E-posta başarıyla gönderildi');
                    setTimeout(() => {
                        window.location.href = '/admin/mails';
                    }, 1500);
                } else {
                    showErrorAlert(result.message || 'E-posta gönderilemedi');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showErrorAlert('E-posta gönderilirken hata oluştu');
            }
            
            return false;
        });
    </script>
}
