@model BalonPark.Models.ProductCardViewModel
@inject BalonPark.Services.IUrlService UrlService
@{
    var item = Model.Item;
    var product = item.Product;
    var productUrl = Model.ProductUrl ?? $"/category/{product.CategorySlug}/{product.SubCategorySlug}/{product.Slug}";
    var baseUrl = UrlService.GetBaseUrl();
    if (string.IsNullOrEmpty(baseUrl))
    {
        baseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    }
    var imageUrl = item.MainImage != null
        ? (UrlService.GetImageUrl(item.MainImage.ThumbnailPath) ?? $"{baseUrl}/{item.MainImage.ThumbnailPath.TrimStart('/')}")
        : (UrlService.GetImageUrl("/assets/images/no-image.png") ?? $"{baseUrl}/assets/images/no-image.png");
    var descriptionSnippet = !string.IsNullOrEmpty(product.Description) && product.Description.Length > 60
        ? product.Description.Substring(0, 60) + "..."
        : product.Description ?? "";
}

<article class="product-card group bg-white rounded-xl overflow-hidden flex flex-col h-full">
    <div class="relative aspect-square bg-gray-50 overflow-hidden flex-shrink-0">
        <div class="product-card-actions absolute top-1.5 right-1.5 z-10 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
            <button type="button" class="favorite-btn flex items-center justify-center w-6 h-6 rounded-full bg-white/90 text-gray-500 hover:text-primary shadow-sm transition" data-product-id="@product.Id" title="Favorilere Ekle"><i data-lucide="heart" class="w-3 h-3"></i></button>
            <button type="button" class="compare-btn flex items-center justify-center w-6 h-6 rounded-full bg-white/90 text-gray-500 hover:text-primary shadow-sm transition" data-product-id="@product.Id" data-product-url="@productUrl" data-product-slug="@product.Slug" title="Karşılaştır"><i data-lucide="shuffle" class="w-3 h-3"></i></button>
        </div>
        <a href="@productUrl" class="block w-full h-full product-image-wrap overflow-hidden">
            <span class="img-loading-spinner" aria-hidden="true"></span>
            <img src="@imageUrl" class="lazy-image w-full h-full object-cover" alt="@Html.Raw(product.Name)" loading="lazy" onload="this.classList.add('loaded'); var s=this.previousElementSibling; if(s) s.classList.add('hidden');">
        </a>
    </div>
    <div class="p-3 flex flex-col flex-1 min-h-0 border-t border-gray-100">
        <a href="@productUrl" class="font-medium text-sm text-ink hover:text-primary line-clamp-2 transition">@Html.Raw(product.Name)</a>
        <p class="text-xs text-gray-400 mt-0.5 flex-shrink-0">@Html.Raw(product.CategoryName)</p>
        @if (!string.IsNullOrEmpty(product.Description))
        {
            <p class="text-xs text-gray-500 mt-1 line-clamp-2 flex-1 min-h-0">@Html.Raw(descriptionSnippet)</p>
        }
        else
        {
            <div class="flex-1 min-h-[2.5rem]"></div>
        }
        <div class="mt-auto pt-2.5">
            @if (product.Price <= 0)
            {
                <p class="text-xs text-gray-500">Fiyat için iletişime geçin</p>
            }
            else
            {
                <p class="price-tl text-sm font-medium text-primary @(Model.SelectedCurrency == "TL" ? "block" : "hidden")">₺@product.Price.ToString("N0")</p>
                <p class="price-usd text-sm font-medium text-primary @(Model.SelectedCurrency == "USD" ? "block" : "hidden")">$@product.UsdPrice.ToString("N0")</p>
                <p class="price-eur text-sm font-medium text-primary @(Model.SelectedCurrency == "EUR" ? "block" : "hidden")">€@product.EuroPrice.ToString("N0")</p>
            }
        </div>
    </div>
</article>
