@page "/category/{categorySlug}/{subCategorySlug}"
@model ProductsModel
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = $"{Model.SubCategory?.CategoryName} - {Model.SubCategory?.Name}";
    ViewData["Description"] = !string.IsNullOrEmpty(Model.SubCategory?.Description)
        ? $"{Model.SubCategory.CategoryName} - {Model.SubCategory.Name}: {Model.SubCategory.Description} | {companyName}"
        : $"{Model.SubCategory?.CategoryName} - {Model.SubCategory?.Name} şişme oyun grupları ve oyuncakları. {companyName}'ta kaliteli şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar.";
    ViewData["Keywords"] = $"{Model.SubCategory?.CategoryName}, {Model.SubCategory?.Name}, şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları, balon park";
    ViewData["Image"] = settings?.Logo != null ? (((IUrlService?)ViewData["UrlService"])?.GetImageUrl(settings.Logo) ?? settings.Logo) : (((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/logo/logo.png");
}

<!-- SubCategory Products Structured Data -->
@if (Model.SubCategory != null)
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@Html.Raw(Model.SubCategory.CategoryName) - @Html.Raw(Model.SubCategory.Name)",
        "description": "@Html.Raw(Model.SubCategory.Description ?? Model.SubCategory.CategoryName + " - " + Model.SubCategory.Name + " şişme oyun grupları ve oyuncakları")",
        "url": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.CategorySlug}/{Model.SubCategory.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}/{Model.SubCategory.Slug}")",
        "mainEntity": {
            "@@type": "ItemList",
            "name": "@Html.Raw(Model.SubCategory.Name) Ürünleri",
            "description": "@Html.Raw(Model.SubCategory.Description ?? Model.SubCategory.Name + " kategorisindeki tüm ürünler")",
            "numberOfItems": "@Model.Products.Count",
            "itemListElement": [
                @for (int i = 0; i < Model.Products.Count && i < 20; i++)
                {
                    var productWithImage = Model.Products[i];
                    var product = productWithImage.Product;
                    @: {
                    @:     "@@type": "ListItem",
                    @:     "position": @(i + 1),
                    @:     "item": {
                    @:         "@@type": "Product",
                    @:         "name": "@Html.Raw(product.Name)",
                    @:         "description": "@Html.Raw(product.Description ?? product.Name)",
                    @:         "url": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.CategorySlug, Model.SubCategory.Slug, product.Slug) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}/{Model.SubCategory.Slug}/{product.Slug}")",
                    @:         "image": "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png")}")",
                    @:         "offers": {
                    @:             "@@type": "Offer",
                    @:             "price": "@product.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)",
                    @:             "priceCurrency": "TRY",
                    @:             "availability": "@(product.Stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")"
                    @:         }
                    @:     }
                    @: }@(i < Math.Min(Model.Products.Count, 20) - 1 ? "," : "")
                }
            ]
        },
        "breadcrumb": {
            "@@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@@type": "ListItem",
                    "position": 1,
                    "name": "Ana Sayfa",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl("/") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/")"
                },
                {
                    "@@type": "ListItem",
                    "position": 2,
                    "name": "@Html.Raw(Model.SubCategory.CategoryName)",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.CategorySlug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}")"
                },
                {
                    "@@type": "ListItem",
                    "position": 3,
                    "name": "@Html.Raw(Model.SubCategory.Name)",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.CategorySlug}/{Model.SubCategory.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}/{Model.SubCategory.Slug}")"
                }
            ]
        }
    }
    </script>
}

<div class="space-y-4 sm:space-y-6">
    @await Html.PartialAsync("Shared/_Breadcrumb", new List<BreadcrumbItem>
    {
        BreadcrumbItem.Link("Ana Sayfa", "/"),
        BreadcrumbItem.Link(Model.SubCategory?.CategoryName ?? "Kategori", $"/category/{Model.CategorySlug}"),
        BreadcrumbItem.Current(Model.SubCategory?.Name ?? "Ürünler")
    })

    <div class="category-intro">
        <h2 class="category-intro__title">
            <span class="category-intro__title-icon" aria-hidden="true"><i data-lucide="layers" class="w-5 h-5"></i></span>
            @Html.Raw(Model.SubCategory?.CategoryName) &gt; @Html.Raw(Model.SubCategory?.Name)
        </h2>
        @if (!string.IsNullOrEmpty(Model.SubCategory?.Description))
        {
            <div class="category-intro__desc">@Html.Raw(Model.SubCategory.Description)</div>
        }
        else
        {
            <p class="category-intro__desc">@Html.Raw(Model.SubCategory?.Name) kategorisindeki harika ürünlerimizi keşfedin.</p>
        }
    </div>

    @if (Model.Products.Any())
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            @foreach (var item in Model.Products)
            {
                @await Html.PartialAsync("Shared/_ProductCard", new ProductCardViewModel { Item = item, ProductUrl = $"/category/{Model.CategorySlug}/{Model.SubCategory?.Slug}/{item.Product.Slug}", SelectedCurrency = Model.SelectedCurrency })
            }
        </div>
    }
    else
    {
        @await Html.PartialAsync("Shared/_ResultNotFound", new ResultNotFoundViewModel
        {
            Icon = "package-open",
            Title = "Ürün bulunmamaktadır",
            Description = "Bu kategoride henüz ürün bulunmamaktadır. Lütfen daha sonra tekrar kontrol edin.",
            PrimaryActionText = Model.SubCategory?.CategoryName + "'e Dön",
            PrimaryActionUrl = $"/category/{Model.CategorySlug}",
            PrimaryActionIcon = "arrow-left",
            PrimaryActionIsPrimary = false
        })
    }

    @if (Model.TotalPages > 1)
    {
        <nav class="flex justify-center items-center gap-1.5 flex-wrap mt-6" aria-label="Sayfa navigasyonu">
            @if (Model.CurrentPage > 1)
            {
                <a href="?PageNumber=@(Model.CurrentPage - 1)" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition" aria-label="Önceki">&laquo;</a>
            }
            @{
                int startPage = Math.Max(1, Model.CurrentPage - 2);
                int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
            }
            @if (startPage > 1)
            {
                <a href="?PageNumber=1" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">1</a>
                @if (startPage > 2) { <span class="px-1.5 text-gray-400 text-sm">...</span> }
            }
            @for (int i = startPage; i <= endPage; i++)
            {
                @if (i == Model.CurrentPage)
                {
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded bg-primary text-white text-sm font-medium">@i</span>
                }
                else
                {
                    <a href="?PageNumber=@i" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">@i</a>
                }
            }
            @if (endPage < Model.TotalPages)
            {
                @if (endPage < Model.TotalPages - 1) { <span class="px-1.5 text-gray-400 text-sm">...</span> }
                <a href="?PageNumber=@Model.TotalPages" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">@Model.TotalPages</a>
            }
            @if (Model.CurrentPage < Model.TotalPages)
            {
                <a href="?PageNumber=@(Model.CurrentPage + 1)" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition" aria-label="Sonraki">&raquo;</a>
            }
            <span class="text-xs text-gray-500 ml-3">Sayfa @Model.CurrentPage / @Model.TotalPages (@Model.TotalProducts ürün)</span>
        </nav>
    }
</div>
