@page "/category/{categorySlug}/{subCategorySlug}"
@model ProductsModel
@{
    var settings = ViewData["SiteSettings"] as BalonPark.Models.Settings;
    var companyName = settings?.CompanyName ?? "Balon Park Şişme Oyun Grupları";
    ViewData["Title"] = $"{Model.SubCategory?.CategoryName} - {Model.SubCategory?.Name}";
    ViewData["Description"] = !string.IsNullOrEmpty(Model.SubCategory?.Description)
        ? $"{Model.SubCategory.CategoryName} - {Model.SubCategory.Name}: {Model.SubCategory.Description} | {companyName}"
        : $"{Model.SubCategory?.CategoryName} - {Model.SubCategory?.Name} şişme oyun grupları ve oyuncakları. {companyName}'ta kaliteli şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar.";
    ViewData["Keywords"] = $"{Model.SubCategory?.CategoryName}, {Model.SubCategory?.Name}, şişme oyun parkı, şişme kaydırak, şişme havuz, şişme rodeo, top havuzu, iç mekan oyun parkları, trambolin, softplay oyuncaklar, yer balonları, balon tak, fly tüp, şişme kostüm, reklam balonları, balon park";
    ViewData["Image"] = settings?.Logo != null ? (((IUrlService?)ViewData["UrlService"])?.GetImageUrl(settings.Logo) ?? settings.Logo) : (((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/logo/logo.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/logo/logo.png");
}

<!-- SubCategory Products Structured Data -->
@if (Model.SubCategory != null)
{
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@Html.Raw(Model.SubCategory.CategoryName) - @Html.Raw(Model.SubCategory.Name)",
        "description": "@Html.Raw(Model.SubCategory.Description ?? Model.SubCategory.CategoryName + " - " + Model.SubCategory.Name + " şişme oyun grupları ve oyuncakları")",
        "url": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.CategorySlug}/{Model.SubCategory.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}/{Model.SubCategory.Slug}")",
        "mainEntity": {
            "@@type": "ItemList",
            "name": "@Html.Raw(Model.SubCategory.Name) Ürünleri",
            "description": "@Html.Raw(Model.SubCategory.Description ?? Model.SubCategory.Name + " kategorisindeki tüm ürünler")",
            "numberOfItems": "@Model.Products.Count",
            "itemListElement": [
                @for (int i = 0; i < Model.Products.Count && i < 20; i++)
                {
                    var productWithImage = Model.Products[i];
                    var product = productWithImage.Product;
                    @: {
                    @:     "@@type": "ListItem",
                    @:     "position": @(i + 1),
                    @:     "item": {
                    @:         "@@type": "Product",
                    @:         "name": "@Html.Raw(product.Name)",
                    @:         "description": "@Html.Raw(product.Description ?? product.Name)",
                    @:         "url": "@(((IUrlService?)ViewData["UrlService"])?.GetProductUrl(Model.CategorySlug, Model.SubCategory.Slug, product.Slug) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}/{Model.SubCategory.Slug}/{product.Slug}")",
                    @:         "image": "@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{(productWithImage.MainImage?.LargePath ?? "/assets/images/no-image.png")}")",
                    @:         "offers": {
                    @:             "@@type": "Offer",
                    @:             "price": "@product.Price.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)",
                    @:             "priceCurrency": "TRY",
                    @:             "availability": "@(product.Stock > 0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")"
                    @:         }
                    @:     }
                    @: }@(i < Math.Min(Model.Products.Count, 20) - 1 ? "," : "")
                }
            ]
        },
        "breadcrumb": {
            "@@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@@type": "ListItem",
                    "position": 1,
                    "name": "Ana Sayfa",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl("/") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/")"
                },
                {
                    "@@type": "ListItem",
                    "position": 2,
                    "name": "@Html.Raw(Model.SubCategory.CategoryName)",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.CategorySlug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}")"
                },
                {
                    "@@type": "ListItem",
                    "position": 3,
                    "name": "@Html.Raw(Model.SubCategory.Name)",
                    "item": "@(((IUrlService?)ViewData["UrlService"])?.GetPageUrl($"/category/{Model.CategorySlug}/{Model.SubCategory.Slug}") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/category/{Model.CategorySlug}/{Model.SubCategory.Slug}")"
                }
            ]
        }
    }
    </script>
}

<div class="space-y-4 sm:space-y-6">
    <nav class="flex items-center gap-1.5 text-sm text-gray-500" aria-label="Breadcrumb">
        <a href="/" class="text-ink hover:text-primary transition">Ana Sayfa</a>
        <span>/</span>
        <a href="/category/@Model.CategorySlug" class="text-ink hover:text-primary transition">@Html.Raw(Model.SubCategory?.CategoryName)</a>
        <span>/</span>
        <span class="text-ink font-medium">@Html.Raw(Model.SubCategory?.Name)</span>
    </nav>

    <div class="pt-1 pb-2.5 border-b border-gray-100">
        <h2 class="text-ink text-base font-medium">@Html.Raw(Model.SubCategory?.CategoryName) &gt; @Html.Raw(Model.SubCategory?.Name) <span class="text-gray-400 font-normal">(@Model.TotalProducts ürün)</span></h2>
        @if (!string.IsNullOrEmpty(Model.SubCategory?.Description))
        {
            <p class="text-gray-500 text-xs mt-0.5">@Html.Raw(Model.SubCategory.Description)</p>
        }
        else
        {
            <p class="text-gray-500 text-xs mt-0.5">@Html.Raw(Model.SubCategory?.Name) kategorisindeki harika ürünlerimizi keşfedin</p>
        }
    </div>

    @if (Model.Products.Any())
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            @foreach (var item in Model.Products)
            {
                <article class="product-card group bg-white rounded border border-gray-100 overflow-hidden hover:border-gray-200 hover:bg-gray-50/50 transition-all duration-200 flex flex-col">
                    <div class="relative aspect-square bg-gray-50 overflow-hidden">
                        <div class="product-card-actions absolute top-2 right-2 z-10 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button type="button" class="favorite-btn flex items-center justify-center transition" data-product-id="@item.Product.Id" title="Favorilere Ekle"><i data-lucide="heart"></i></button>
                            <button type="button" class="compare-btn flex items-center justify-center transition" data-product-id="@item.Product.Id" data-product-url="/category/@Model.CategorySlug/@Model.SubCategory?.Slug/@item.Product.Slug" data-product-slug="@item.Product.Slug" title="Karşılaştır"><i data-lucide="shuffle"></i></button>
                        </div>
                        <a href="/category/@Model.CategorySlug/@Model.SubCategory?.Slug/@item.Product.Slug" class="block w-full h-full">
                        @if (item.MainImage != null)
                        {
                            <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl(item.MainImage.ThumbnailPath) ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/{item.MainImage.ThumbnailPath}")" class="lazy-image w-full h-full object-cover group-hover:opacity-95 transition-opacity duration-200" alt="@Html.Raw(item.Product.Name)" loading="lazy">
                        }
                        else
                        {
                            <img src="@(((IUrlService?)ViewData["UrlService"])?.GetImageUrl("/assets/images/no-image.png") ?? $"{HttpContext.Request.Scheme}://{HttpContext.Request.Host}/assets/images/no-image.png")" class="lazy-image w-full h-full object-cover" alt="@Html.Raw(item.Product.Name)" loading="lazy">
                        }
                        </a>
                    </div>
                    <div class="p-3 flex flex-col flex-1 border-t border-gray-100">
                        <a href="/category/@Model.CategorySlug/@Model.SubCategory?.Slug/@item.Product.Slug" class="font-medium text-sm text-ink hover:text-primary line-clamp-2 transition">@Html.Raw(item.Product.Name)</a>
                        <p class="text-xs text-gray-400 mt-0.5">@Html.Raw(item.Product.CategoryName)</p>
                        @if (!string.IsNullOrEmpty(item.Product.Description))
                        {
                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">@Html.Raw(item.Product.Description.Length > 60 ? item.Product.Description.Substring(0, 60) + "..." : item.Product.Description)</p>
                        }
                        @if (!string.IsNullOrEmpty(item.Product.Summary))
                        {
                            <p class="text-[11px] text-gray-500 mt-1 line-clamp-2">@Html.Raw(item.Product.Summary)</p>
                        }
                        <div class="mt-auto pt-2.5">
                            @if (item.Product.Price <= 0)
                            {
                                <p class="text-xs text-gray-500">Fiyat için iletişime geçin</p>
                            }
                            else
                            {
                                <p class="price-tl text-sm font-medium text-primary @(Model.SelectedCurrency == "TL" ? "block" : "hidden")">₺@item.Product.Price.ToString("N2")</p>
                                <p class="price-usd text-sm font-medium text-primary @(Model.SelectedCurrency == "USD" ? "block" : "hidden")">$@item.Product.UsdPrice.ToString("N2")</p>
                                <p class="price-eur text-sm font-medium text-primary @(Model.SelectedCurrency == "EUR" ? "block" : "hidden")">€@item.Product.EuroPrice.ToString("N2")</p>
                            }
                        </div>
                    </div>
                </article>
            }
        </div>
    }
    else
    {
        <div class="text-center py-12 px-4 bg-gray-50 rounded border border-gray-100">
            <i data-lucide="package-open" class="w-12 h-12 text-gray-300 mb-3"></i>
            <h3 class="text-base font-medium text-ink">Ürün bulunmamaktadır</h3>
            <p class="text-sm text-gray-500 mt-1">Bu kategoride henüz ürün bulunmamaktadır. Lütfen daha sonra tekrar kontrol edin.</p>
            <a href="/category/@Model.CategorySlug" class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 border border-gray-200 text-ink font-medium text-sm rounded-lg hover:bg-gray-50 transition w-fit">
                <i data-lucide="arrow-left" class="w-4 h-4 inline-block align-middle"></i> @Model.SubCategory?.CategoryName'e Dön
            </a>
        </div>
    }

    @if (Model.TotalPages > 1)
    {
        <nav class="flex justify-center items-center gap-1.5 flex-wrap mt-6" aria-label="Sayfa navigasyonu">
            @if (Model.CurrentPage > 1)
            {
                <a href="?PageNumber=@(Model.CurrentPage - 1)" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition" aria-label="Önceki">&laquo;</a>
            }
            @{
                int startPage = Math.Max(1, Model.CurrentPage - 2);
                int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
            }
            @if (startPage > 1)
            {
                <a href="?PageNumber=1" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">1</a>
                @if (startPage > 2) { <span class="px-1.5 text-gray-400 text-sm">...</span> }
            }
            @for (int i = startPage; i <= endPage; i++)
            {
                @if (i == Model.CurrentPage)
                {
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded bg-primary text-white text-sm font-medium">@i</span>
                }
                else
                {
                    <a href="?PageNumber=@i" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">@i</a>
                }
            }
            @if (endPage < Model.TotalPages)
            {
                @if (endPage < Model.TotalPages - 1) { <span class="px-1.5 text-gray-400 text-sm">...</span> }
                <a href="?PageNumber=@Model.TotalPages" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition">@Model.TotalPages</a>
            }
            @if (Model.CurrentPage < Model.TotalPages)
            {
                <a href="?PageNumber=@(Model.CurrentPage + 1)" class="inline-flex items-center justify-center w-9 h-9 rounded border border-gray-200 text-ink text-sm hover:bg-gray-50 transition" aria-label="Sonraki">&raquo;</a>
            }
            <span class="text-xs text-gray-500 ml-3">Sayfa @Model.CurrentPage / @Model.TotalPages (@Model.TotalProducts ürün)</span>
        </nav>
    }
</div>
